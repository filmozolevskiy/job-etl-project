{% extends "base.html" %}

{% block title %}Jobs{% if profile_name %} - {{ profile_name }}{% endif %} - Profile Management{% endblock %}

{% block extra_css %}
<style>
    .jobs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .jobs-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .jobs-filters select {
        min-width: 150px;
    }
    
    .perfect-fit-score {
        font-weight: 600;
        color: #28a745;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-waiting {
        background-color: #e7d5ff;
        color: #6a1b9a;
    }
    
    .status-applied {
        background-color: #c8e6c9;
        color: #2e7d32;
    }
    
    .status-rejected {
        background-color: #ffcdd2;
        color: #c62828;
    }
    
    .status-interview {
        background-color: #fff9c4;
        color: #f57f17;
    }
    
    .status-offer {
        background-color: #c5e1a5;
        color: #33691e;
    }
    
    .status-archived {
        background-color: #cfd8dc;
        color: #37474f;
    }
    
    .note-icon {
        cursor: pointer;
        color: #007bff;
        margin-right: 0.5rem;
    }
    
    .note-icon:hover {
        color: #0056b3;
    }
    
    .note-preview {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    .status-dropdown {
        padding: 0.25rem 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.875rem;
        cursor: pointer;
    }
    
    .action-column {
        white-space: nowrap;
    }
    
    .job-posting-link {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        color: #007bff;
        text-decoration: none;
    }
    
    .job-posting-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="jobs-header">
        <div class="card-header" style="margin-bottom: 0;">
            Jobs{% if profile_name %} - {{ profile_name }}{% endif %}
        </div>
        <div>
            {% if profile_id %}
                <a href="{{ url_for('view_profile', profile_id=profile_id) }}" class="btn btn-secondary">Back to Profile</a>
            {% else %}
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Profiles</a>
            {% endif %}
        </div>
    </div>
    
    {% if jobs %}
    <table>
        <thead>
            <tr>
                <th>Company Name</th>
                <th>Status</th>
                <th>Updated At</th>
                <th>Job Posting</th>
                <th>Perfect Fit</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td><strong>{{ job.company_name or 'Unknown' }}</strong></td>
                <td>
                    <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" onchange="this.submit()">
                        <select name="status" class="status-dropdown">
                            <option value="waiting" {% if (job.job_status or 'waiting') == 'waiting' %}selected{% endif %}>Waiting</option>
                            <option value="applied" {% if job.job_status == 'applied' %}selected{% endif %}>Applied</option>
                            <option value="interview" {% if job.job_status == 'interview' %}selected{% endif %}>Interview</option>
                            <option value="offer" {% if job.job_status == 'offer' %}selected{% endif %}>Offer</option>
                            <option value="rejected" {% if job.job_status == 'rejected' %}selected{% endif %}>Rejected</option>
                            <option value="archived" {% if job.job_status == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </form>
                </td>
                <td>
                    {% if job.ranked_at %}
                        {{ job.ranked_at.strftime('%Y-%m-%d %H:%M') if job.ranked_at.__class__.__name__ != 'str' else job.ranked_at }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {{ job.job_title }}
                    {% if job.apply_options %}
                        {% set apply_options_parsed = job.apply_options | from_json %}
                        {% if apply_options_parsed %}
                            {% if apply_options_parsed is mapping %}
                                {% set apply_link = apply_options_parsed.get('apply_link') %}
                            {% elif apply_options_parsed is iterable and apply_options_parsed[0] is mapping %}
                                {% set apply_link = apply_options_parsed[0].get('apply_link') %}
                            {% endif %}
                            {% if apply_link %}
                                <a href="{{ apply_link }}" target="_blank" class="job-posting-link" title="Open job posting">
                                    <span>üîó</span>
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    <span class="perfect-fit-score">{{ "%.0f"|format(job.rank_score) if job.rank_score else 0 }}</span>
                    <span>Perfect fit</span>
                </td>
                <td class="action-column">
                    {% if job.note_text %}
                        <div class="note-preview" title="{{ job.note_text|e }}">
                            {{ job.note_text[:50] }}{% if job.note_text|length > 50 %}...{% endif %}
                        </div>
                    {% endif %}
                    <button class="note-icon" onclick="openNoteModal('{{ job.jsearch_job_id }}', '{{ job.job_title|e }}', '{{ job.note_text|e if job.note_text else '' }}')" title="{% if job.note_text %}Edit Note{% else %}Add Note{% endif %}">
                        {% if job.note_text %}üìù{% else %}‚ûï{% endif %}
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No jobs found.</p>
    {% endif %}
</div>

<!-- Note Modal -->
<div id="noteModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 2rem; border-radius: 4px; width: 80%; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-top: 0;">Add Note for <span id="modalJobTitle"></span></h2>
        <form id="noteForm" method="POST" action="">
            <input type="hidden" name="job_id" id="modalJobId">
            <div class="form-group">
                <label for="note_text">Note:</label>
                <textarea id="note_text" name="note_text" rows="5" style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Note</button>
                <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function openNoteModal(jobId, jobTitle, existingNote) {
    document.getElementById('modalJobId').value = jobId;
    document.getElementById('modalJobTitle').textContent = jobTitle;
    document.getElementById('note_text').value = (existingNote || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&lt;/g, '<').replace(/&gt;/g, '>');
    document.getElementById('noteForm').action = '/jobs/' + encodeURIComponent(jobId) + '/note';
    document.getElementById('noteModal').style.display = 'block';
}

function closeNoteModal() {
    document.getElementById('noteModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('noteModal');
    if (event.target == modal) {
        closeNoteModal();
    }
}
</script>
{% endblock %}

