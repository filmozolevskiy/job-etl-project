{% extends "base.html" %}

{% block title %}{{ profile.profile_name }} - Profile Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Profile: {{ profile.profile_name }}
        <span style="float: right;">
            {% if profile.is_active %}
                <span class="badge badge-success">Active</span>
            {% else %}
                <span class="badge badge-secondary">Inactive</span>
            {% endif %}
        </span>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <a href="{{ url_for('edit_profile', profile_id=profile.profile_id) }}" class="btn btn-primary">Edit Profile</a>
        <a href="{{ url_for('view_jobs', profile_id=profile.profile_id) }}" class="btn btn-primary">View Jobs</a>
        <form method="POST" action="{{ url_for('trigger_profile_dag', profile_id=profile.profile_id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success" onclick="return confirm('Trigger DAG run for this profile?');">Run DAG</button>
        </form>
        <form method="POST" action="{{ url_for('toggle_active', profile_id=profile.profile_id) }}" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
                {% if profile.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>
        </form>
        <form method="POST" action="{{ url_for('delete_profile', profile_id=profile.profile_id) }}" 
              style="display: inline;"
              onsubmit="return confirm('Are you sure you want to delete this profile? This action cannot be undone.');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
    
    <h3>Search Criteria</h3>
    <table style="margin-top: 1rem;">
        <tr>
            <th style="width: 200px;">Query</th>
            <td>{{ profile.query }}</td>
        </tr>
        <tr>
            <th>Location</th>
            <td>{{ profile.location or '-' }}</td>
        </tr>
        <tr>
            <th>Country</th>
            <td>{{ profile.country or '-' }}</td>
        </tr>
        <tr>
            <th>Date Window</th>
            <td>{{ profile.date_window or '-' }}</td>
        </tr>
        <tr>
            <th>Skills</th>
            <td>{{ profile.skills or '-' }}</td>
        </tr>
        <tr>
            <th>Salary Range</th>
            <td>
                {% if profile.min_salary or profile.max_salary %}
                    {% if profile.currency %}{{ profile.currency }}{% else %}USD{% endif %} 
                    {% if profile.min_salary %}{{ "%.0f"|format(profile.min_salary) }}{% endif %}
                    {% if profile.min_salary and profile.max_salary %} - {% endif %}
                    {% if profile.max_salary %}{{ "%.0f"|format(profile.max_salary) }}{% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Currency</th>
            <td>{{ profile.currency or 'USD (default)' }}</td>
        </tr>
        <tr>
            <th>Remote Preference</th>
            <td>{{ profile.remote_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Seniority</th>
            <td>{{ profile.seniority | format_list }}</td>
        </tr>
        <tr>
            <th>Company Size Preference</th>
            <td>{{ profile.company_size_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Employment Type Preference</th>
            <td>{{ profile.employment_type_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Email</th>
            <td>{{ profile.email or '-' }}</td>
        </tr>
    </table>
    
    <h3 style="margin-top: 2rem;">Statistics</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value">{{ profile.total_run_count or 0 }}</div>
            <div class="stat-label">Total Runs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ profile.last_run_job_count or 0 }}</div>
            <div class="stat-label">Last Run Jobs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% if profile.last_run_status == 'success' %}
                    <span style="color: #28a745;">✓</span>
                {% elif profile.last_run_status == 'error' %}
                    <span style="color: #dc3545;">✗</span>
                {% else %}
                    -
                {% endif %}
            </div>
            <div class="stat-label">Last Run Status</div>
        </div>
        {% if statistics %}
        <div class="stat-item">
            <div class="stat-value">{{ "%.1f"|format(statistics.avg_rank_score or 0) }}</div>
            <div class="stat-label">Avg Ranking Score</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ statistics.total_ranked_jobs or 0 }}</div>
            <div class="stat-label">Total Ranked Jobs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ "%.1f"|format(statistics.success_rate or 0) }}%</div>
            <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ statistics.jobs_last_30_days or 0 }}</div>
            <div class="stat-label">Jobs (Last 30 Days)</div>
        </div>
        {% endif %}
    </div>
    
    {% if job_counts %}
    <h3 style="margin-top: 2rem;">Job Counts Over Time (Last 30 Days)</h3>
    <div style="margin-top: 1rem;">
        <canvas id="jobCountsChart" style="max-height: 300px;"></canvas>
    </div>
    {% endif %}
    
    {% if run_history %}
    <h3 style="margin-top: 2rem;">Recent Run History</h3>
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>Run Time</th>
                <th>Task</th>
                <th>Status</th>
                <th>Jobs Processed</th>
                <th>Duration (s)</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for run in run_history %}
            <tr>
                <td>{{ run.run_timestamp.strftime('%Y-%m-%d %H:%M:%S') if run.run_timestamp else '-' }}</td>
                <td>{{ run.task_name or '-' }}</td>
                <td>
                    {% if run.task_status == 'success' %}
                        <span class="badge badge-success">Success</span>
                    {% elif run.task_status == 'failed' %}
                        <span class="badge badge-danger">Failed</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ run.task_status or '-' }}</span>
                    {% endif %}
                </td>
                <td>{{ run.rows_processed_raw or 0 }}</td>
                <td>{{ "%.2f"|format(run.processing_duration_seconds) if run.processing_duration_seconds else '-' }}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    {{ run.error_message[:50] + '...' if run.error_message and run.error_message|length > 50 else (run.error_message or '-') }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    
    <h3 style="margin-top: 2rem;">Timestamps</h3>
    <table style="margin-top: 1rem;">
        <tr>
            <th style="width: 200px;">Created At</th>
            <td>{{ profile.created_at.strftime('%Y-%m-%d %H:%M:%S') if profile.created_at else '-' }}</td>
        </tr>
        <tr>
            <th>Updated At</th>
            <td>{{ profile.updated_at.strftime('%Y-%m-%d %H:%M:%S') if profile.updated_at else '-' }}</td>
        </tr>
        <tr>
            <th>Last Run At</th>
            <td>{{ profile.last_run_at.strftime('%Y-%m-%d %H:%M:%S') if profile.last_run_at else 'Never' }}</td>
        </tr>
    </table>
    
    <div style="margin-top: 2rem;">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to All Profiles</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if job_counts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    const jobCountsData = {{ job_counts | tojson }};
    const ctx = document.getElementById('jobCountsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: jobCountsData.map(d => d.run_date),
            datasets: [{
                label: 'Jobs Extracted',
                data: jobCountsData.map(d => d.job_count),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}

