name: CI

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "ruff>=0.8,<0.9"

      - name: Run ruff check
        run: ruff check . --output-format=github

      - name: Check code formatting
        run: ruff format --check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: job_search_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      TEST_DB_CONNECTION_STRING: postgresql://postgres:postgres@127.0.0.1:5432/job_search_test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h 127.0.0.1 -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Initialize database schemas
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/01_create_schemas.sql

      - name: Create tables
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/02_create_tables.sql

      - name: Create dbt tables for tests (staging.jsearch_job_postings, marts.fact_jobs, marts.dim_companies)
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/07_create_dbt_tables_for_tests.sql

      - name: Run document tables migration
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/08_add_resume_cover_letter_tables.sql

      - name: Run documents section migration
        run: |
          set -e
          echo "Running migration script..."
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/09_add_documents_section_flag.sql
          echo "Verifying migration..."
          # Verify migration succeeded - check both tables
          RESUME_COUNT=$(PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -t -A -c "SELECT COUNT(*) FROM information_schema.columns WHERE table_schema = 'marts' AND table_name = 'user_resumes' AND column_name = 'in_documents_section';")
          COVER_LETTER_COUNT=$(PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -t -A -c "SELECT COUNT(*) FROM information_schema.columns WHERE table_schema = 'marts' AND table_name = 'user_cover_letters' AND column_name = 'in_documents_section';")
          if [ "$RESUME_COUNT" -ne "1" ]; then
            echo "ERROR: Migration failed - in_documents_section column not found in user_resumes (count: $RESUME_COUNT)"
            exit 1
          fi
          if [ "$COVER_LETTER_COUNT" -ne "1" ]; then
            echo "ERROR: Migration failed - in_documents_section column not found in user_cover_letters (count: $COVER_LETTER_COUNT)"
            exit 1
          fi
          echo "Migration verification: Both columns exist successfully"

      - name: Create user job status table
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/14_create_user_job_status_table.sql

      - name: Create job status history table
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/14_add_job_status_history_table.sql

      - name: Modify job notes for multi-note support
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/15_modify_job_notes_multi_note.sql

      - name: Add job notes indexes
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/16_add_job_notes_indexes.sql

      - name: Create staging slots table
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/18_create_staging_slots_table.sql

      - name: Seed admin user
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/19_seed_admin_user.sql

      - name: Add campaign_id to user tables
        run: |
          set -e
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_test -f docker/init/21_add_campaign_id_to_user_tables.sql

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: pytest tests/ --ignore=tests/browser -v --cov=services --cov-report=term-missing

      # Note: Codecov upload is optional and requires a token
      # Uncomment and add CODECOV_TOKEN to GitHub secrets if you want coverage reporting
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v4
      #   if: always()
      #   with:
      #     files: ./htmlcov/coverage.xml
      #     fail_ci_if_error: false
      #     token: ${{ secrets.CODECOV_TOKEN }}

  dbt-test:
    name: dbt Tests
    runs-on: ubuntu-latest
    if: false  # Disabled by default. Set to true when you want to run dbt tests in CI
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: job_search_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      DBT_PROFILES_DIR: ${{ github.workspace }}/.dbt
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: job_search_db
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h 127.0.0.1 -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Initialize database schemas
        run: |
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_db -f docker/init/01_create_schemas.sql

      - name: Create tables
        run: |
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d job_search_db -f docker/init/02_create_tables.sql

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Create profiles.yml for CI
        run: |
          mkdir -p ${{ github.workspace }}/.dbt
          cat > ${{ github.workspace }}/.dbt/profiles.yml << EOF
          job_search_platform:
            target: dev
            outputs:
              dev:
                type: postgres
                host: 127.0.0.1
                port: 5432
                user: postgres
                password: postgres
                dbname: job_search_db
                schema: dbt
                threads: 4
                keepalives_idle: 0
                connect_timeout: 10
          EOF
          cat ${{ github.workspace }}/.dbt/profiles.yml

      - name: Run dbt debug to verify profile connection
        run: dbt debug --project-dir ./dbt

      - name: Build dbt models
        run: dbt run --project-dir ./dbt

      - name: Run dbt tests
        run: dbt test --project-dir ./dbt

