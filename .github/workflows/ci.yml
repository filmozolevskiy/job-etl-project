name: CI

on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "ruff>=0.1.0"

      - name: Run ruff check
        run: ruff check . --output-format=github

      - name: Check code formatting
        run: ruff format --check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: pytest tests/ -v --cov=services --cov-report=term-missing

      # Note: Codecov upload is optional and requires a token
      # Uncomment and add CODECOV_TOKEN to GitHub secrets if you want coverage reporting
      # - name: Upload coverage reports
      #   uses: codecov/codecov-action@v4
      #   if: always()
      #   with:
      #     files: ./htmlcov/coverage.xml
      #     fail_ci_if_error: false
      #     token: ${{ secrets.CODECOV_TOKEN }}

  dbt-test:
    name: dbt Tests
    runs-on: ubuntu-latest
    # dbt tests require a PostgreSQL database with initialized schemas and tables
    # This job is disabled by default. Enable by setting if: false to if: true (or removing the if condition)
    if: true  # Set to true when you want to run dbt tests in CI
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: job_search_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    env:
      DBT_PROFILES_DIR: ${{ github.workspace }}/.dbt
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: job_search_db
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Initialize database schemas
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d job_search_db -f docker/init/01_create_schemas.sql

      - name: Create tables
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d job_search_db -f docker/init/02_create_tables.sql

      - name: Install dbt and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Create profiles.yml for CI
        run: |
          mkdir -p ${{ github.workspace }}/.dbt
          cat > ${{ github.workspace }}/.dbt/profiles.yml << EOF
          job_search_platform:
            target: dev
            outputs:
              dev:
                type: postgres
                host: localhost
                port: 5432
                user: postgres
                password: postgres
                dbname: job_search_db
                schema: dbt
                threads: 4
                keepalives_idle: 0
                connect_timeout: 10
          EOF
          cat ${{ github.workspace }}/.dbt/profiles.yml

      - name: Run dbt debug to verify profile connection
        run: dbt debug --project-dir ./dbt

      - name: Build dbt models
        run: dbt run --project-dir ./dbt

      - name: Run dbt tests
        run: dbt test --project-dir ./dbt

