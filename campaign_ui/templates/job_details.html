{% extends "base.html" %}

{% block title %}Job Details - {{ job.job_title or 'Unknown' }} - Campaign Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Job Details</h1>
    {% if campaign_id %}
    <a href="{{ url_for('view_campaign', campaign_id=campaign_id) }}" class="back-link">← Back to Campaign</a>
    {% else %}
    <a href="{{ url_for('view_jobs') }}" class="back-link">← Back to Jobs</a>
    {% endif %}
</div>

<div class="job-header-card">
    {% set display_company_name = job.company_name or '' %}
    {% if not display_company_name or display_company_name.lower() == 'unknown' %}
        {% if job.apply_options %}
            {% set apply_options_parsed = job.apply_options | from_json %}
            {% if apply_options_parsed %}
                {% if apply_options_parsed is mapping %}
                    {% set display_company_name = apply_options_parsed.get('company_name') or apply_options_parsed.get('employer_name') or apply_options_parsed.get('company') or '' %}
                {% elif apply_options_parsed is iterable %}
                    {% for option in apply_options_parsed %}
                        {% if option is mapping %}
                            {% set temp_name = option.get('company_name') or option.get('employer_name') or option.get('company') %}
                            {% if temp_name %}
                                {% set display_company_name = temp_name %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
    {% if job.company_logo and job.company_logo|trim %}
    <div class="company-logo-large">
        <img src="{{ job.company_logo }}" alt="{{ display_company_name }}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px; background: transparent;" loading="lazy">
    </div>
    {% endif %}
    <div class="job-header-info">
        <h2>{{ job.job_title or 'Unknown Job Title' }}</h2>
        <div class="company-name-large">
            {% if display_company_name and display_company_name.lower() != 'unknown' %}
            <span>{{ display_company_name }}</span>
            {% if job.company_link %}
            <a href="{{ job.company_link }}" 
               target="_blank" 
               class="glassdoor-link">
                <i class="fas fa-external-link-alt"></i> View on Glassdoor
            </a>
            {% endif %}
            {% else %}
            <span>Company not specified</span>
            {% endif %}
        </div>
        
        <div class="job-summary">
            <h3>Job Summary</h3>
            <div class="job-summary-content">
                {% if job.job_summary %}
                    {{ job.job_summary }}
                {% else %}
                    <span style="opacity: 0.5;">No job summary available</span>
                {% endif %}
            </div>
        </div>
        
        <div class="job-additional-info">
            <h3>Additional Information</h3>
            <div class="additional-info-grid">
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-code"></i>
                        Skills
                    </span>
                    <div class="skills-list">
                        {% if job.extracted_skills %}
                            {% set skills_parsed = job.extracted_skills | from_json if job.extracted_skills is string else job.extracted_skills %}
                            {% if skills_parsed is iterable and skills_parsed is not string %}
                                {% for skill in skills_parsed %}
                                    {% if skill %}
                                    <span class="skill-tag">{{ skill }}</span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="skill-tag" style="opacity: 0.5;">No skills listed</span>
                            {% endif %}
                        {% else %}
                            <span class="skill-tag" style="opacity: 0.5;">No skills listed</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-dollar-sign"></i>
                        Salary
                    </span>
                    <span class="info-value">
                        {% if job.job_min_salary or job.job_max_salary %}
                            {% if job.job_min_salary and job.job_max_salary %}
                                ${{ "{:,.0f}".format(job.job_min_salary) }} - ${{ "{:,.0f}".format(job.job_max_salary) }}
                            {% elif job.job_min_salary %}
                                ${{ "{:,.0f}".format(job.job_min_salary) }}+
                            {% elif job.job_max_salary %}
                                Up to ${{ "{:,.0f}".format(job.job_max_salary) }}
                            {% endif %}
                            {% if job.job_salary_period %}
                                / {{ job.job_salary_period }}
                            {% endif %}
                            {% if job.job_salary_currency %}
                                {{ job.job_salary_currency }}
                            {% endif %}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-user-tie"></i>
                        Seniority Level
                    </span>
                    <span class="info-value">
                        {% if job.seniority_level %}
                            {{ job.seniority_level|title }}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-home"></i>
                        Remote Type
                    </span>
                    <span class="info-value">
                        {% if job.remote_work_type %}
                            {{ job.remote_work_type|title }}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-map-marker-alt"></i>
                        Location
                    </span>
                    <span class="info-value">
                        {% if job.job_location %}
                            {{ job.job_location }}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">
                        <i class="fas fa-building"></i>
                        Company Size
                    </span>
                    <span class="info-value">{{ job.company_size or 'Not specified' }}</span>
                </div>
            </div>
        </div>
        
        <div class="job-meta-large">
            <div class="meta-item-large">
                <span class="meta-label">Posted At</span>
                <span class="meta-value">
                    {% if job.posted_at %}
                        {{ job.posted_at.strftime('%Y-%m-%d') if job.posted_at.__class__.__name__ != 'str' else job.posted_at }}
                    {% elif job.ranked_at %}
                        {{ job.ranked_at.strftime('%Y-%m-%d') if job.ranked_at.__class__.__name__ != 'str' else job.ranked_at }}
                    {% else %}
                        Unknown
                    {% endif %}
                </span>
            </div>
            <div class="meta-item-large">
                <span class="meta-label">Rank</span>
                <span class="meta-value">
                    {% set score = job.rank_score or 0 %}
                    {% set score_int = score | int %}
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>
                            {{ score_int }} - 
                            {% if score_int >= 80 %}
                                Perfect Fit
                            {% elif score_int >= 60 %}
                                Good Fit
                            {% else %}
                                Moderate Fit
                            {% endif %}
                        </span>
                        {% if job.rank_explain %}
                        <span class="fit-info-icon" 
                              data-company="{{ job.company_name or 'Unknown' }}" 
                              data-job-title="{{ job.job_title or 'Unknown Title' }}" 
                              data-score="{{ score_int }}"
                              data-breakdown='{{ job.rank_explain | tojson if job.rank_explain else "{}" }}'
                              title="View ranking breakdown">
                            <i class="fas fa-info-circle"></i>
                        </span>
                        {% endif %}
                    </span>
                </span>
            </div>
            <div class="meta-item-large">
                <span class="meta-label">Current Status</span>
                <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" onchange="this.submit()">
                    <select class="status-select-large" name="status" id="jobStatus">
                        <option value="waiting" {% if (job.job_status or 'waiting') == 'waiting' %}selected{% endif %}>Waiting</option>
                        <option value="applied" {% if job.job_status == 'applied' %}selected{% endif %}>Applied</option>
                        <option value="approved" {% if job.job_status == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="interview" {% if job.job_status == 'interview' %}selected{% endif %}>Interview</option>
                        <option value="offer" {% if job.job_status == 'offer' %}selected{% endif %}>Offer</option>
                        <option value="rejected" {% if job.job_status == 'rejected' %}selected{% endif %}>Rejected</option>
                        <option value="archived" {% if job.job_status == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                </form>
            </div>
            <div class="meta-item-large">
                <span class="meta-label">Job Posting</span>
                <span class="meta-value">
                    {% if job.job_apply_link %}
                        <a href="{{ job.job_apply_link }}" target="_blank">View Original →</a>
                    {% else %}
                        <span style="opacity: 0.5;">Not available</span>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<div class="section-card application-documents-section">
    <div class="section-header">
        <h2>Application Documents</h2>
    </div>
    <div class="documents-grid">
        <div class="document-item">
            <div class="document-item-header">
                <h3>Resume</h3>
                <button class="btn btn-primary btn-sm" onclick="showResumeUploadModal()">
                    <i class="fas fa-{% if application_doc and application_doc.resume_id %}edit{% else %}plus{% endif %}"></i> 
                    {% if application_doc and application_doc.resume_id %}Change{% else %}Add{% endif %}
                </button>
            </div>
            {% if application_doc and application_doc.resume_id %}
            <div class="document-current">
                <div class="document-info">
                    <i class="fas fa-file-pdf"></i>
                    <span class="document-name">{{ application_doc.resume_name or 'Resume' }}</span>
                    <span class="document-size">
                        {% if application_doc.resume_file_type == 'application/pdf' %}
                            PDF
                        {% elif 'wordprocessingml' in application_doc.resume_file_type %}
                            DOCX
                        {% endif %}
                    </span>
                </div>
                <div class="document-actions">
                    <a href="{{ url_for('download_resume', job_id=job.jsearch_job_id, resume_id=application_doc.resume_id) }}" 
                       class="btn btn-secondary btn-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
            {% else %}
            <div class="document-empty">
                <p>No resume linked to this job application.</p>
            </div>
            {% endif %}
        </div>
        
        <div class="document-item">
            <div class="document-item-header">
                <h3>Cover Letter</h3>
                <button class="btn btn-primary btn-sm" onclick="showCoverLetterModal()">
                    <i class="fas fa-{% if application_doc and (application_doc.cover_letter_id or application_doc.cover_letter_text) %}edit{% else %}plus{% endif %}"></i> 
                    {% if application_doc and (application_doc.cover_letter_id or application_doc.cover_letter_text) %}Change{% else %}Add{% endif %}
                </button>
            </div>
            {% if application_doc and (application_doc.cover_letter_id or application_doc.cover_letter_text) %}
            {% set has_cover_letter_file = application_doc.cover_letter_id and application_doc.cover_letter_file_path %}
            {% set has_cover_letter_text = application_doc.cover_letter_id and not application_doc.cover_letter_file_path and application_doc.get('cover_letter_text_full') %}
            {% set has_inline_text = application_doc.cover_letter_text and not application_doc.cover_letter_id %}
            <div class="document-current">
                <div class="document-info">
                    {% if application_doc.cover_letter_id %}
                    <i class="fas fa-file-alt"></i>
                    <span class="document-name">{{ application_doc.cover_letter_name or 'Cover Letter' }}</span>
                    {% if has_cover_letter_file %}
                    <span class="document-size">
                        {% if 'pdf' in application_doc.cover_letter_file_path %}
                            PDF
                        {% elif 'docx' in application_doc.cover_letter_file_path %}
                            DOCX
                        {% endif %}
                    </span>
                    {% elif has_cover_letter_text %}
                    <span class="document-size">Text</span>
                    {% endif %}
                    {% elif has_inline_text %}
                    <i class="fas fa-file-alt"></i>
                    <span class="document-name">Text Cover Letter</span>
                    {% endif %}
                </div>
                <div class="document-actions">
                    {% if application_doc.cover_letter_id %}
                    <a href="{{ url_for('download_cover_letter', job_id=job.jsearch_job_id, cover_letter_id=application_doc.cover_letter_id) }}" 
                       class="btn btn-secondary btn-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                    {% elif has_inline_text %}
                    <a href="{{ url_for('download_cover_letter', job_id=job.jsearch_job_id, cover_letter_id=0) }}" 
                       class="btn btn-secondary btn-sm">
                        <i class="fas fa-download"></i> Download as Text
                    </a>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="document-empty">
                <p>No cover letter linked to this job application.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="section-card comments-section">
    <div class="section-header">
        <h2>Application Notes</h2>
        <button id="viewAllNotesBtn" class="btn btn-secondary" onclick="openAllNotesModal()" style="display: none;">
            <i class="fas fa-list"></i> View All Notes
        </button>
    </div>
    
    <!-- Existing Notes Section (at top) - Limited to 3 -->
    <div id="notesListContainer">
        <div id="notesList" style="min-height: 100px;">
            <div class="notes-loading" style="text-align: center; padding: var(--spacing-md);">
                <i class="fas fa-spinner fa-spin"></i> Loading notes...
            </div>
        </div>
    </div>

    <hr style="margin: var(--spacing-lg) 0; border: none; border-top: 1px solid var(--color-border);">

    <!-- Add New Note Section (at bottom) -->
    <div class="form-group" style="margin-top: var(--spacing-lg);">
        <label for="note_text">Add New Note:</label>
        <textarea id="note_text" name="note_text" rows="4" placeholder="Enter your note here..." style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius); font-family: inherit; font-size: var(--font-size-base);"></textarea>
        <div style="margin-top: var(--spacing-sm);">
            <button type="button" class="btn btn-primary" onclick="addNewNote()">
                <i class="fas fa-plus"></i> Add Note
            </button>
        </div>
    </div>
</div>

<div class="section-card">
    <div class="section-header">
        <h2>Job Status History</h2>
        {% if status_history and status_history|length > 3 %}
        <button id="viewAllHistoryBtn" class="btn btn-secondary" onclick="openAllHistoryModal()">
            <i class="fas fa-list"></i> View All History ({{ status_history|length }})
        </button>
        {% endif %}
    </div>
    {% if status_history and status_history|length > 0 %}
    <ul class="status-history">
        {% for entry in status_history[-3:] %}
        <li class="status-history-item">
            <div class="status-info">
                <div class="status-name">
                    {% if entry.status == 'job_found' or entry.status == 'found' or entry.change_type == 'extraction' %}
                        Job found
                    {% elif entry.status == 'updated_by_system' or entry.changed_by == 'system' %}
                        Job posting enriched and ranked
                    {% elif entry.status == 'updated_by_ai' or entry.changed_by == 'ai_enricher' or entry.changed_by == 'chatgpt_enricher' %}
                        Job posting enriched and reranked
                    {% elif entry.status == 'documents_uploaded' or entry.status == 'documents_linked' or entry.change_type == 'document_change' %}
                        {% if entry.metadata and entry.metadata.action == 'uploaded' %}
                            {% if entry.metadata.resume_id and entry.metadata.cover_letter_id %}
                                Resume and cover letter uploaded
                            {% elif entry.metadata.resume_id %}
                                Resume uploaded
                            {% elif entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}
                                Cover letter uploaded
                            {% else %}
                                Documents uploaded
                            {% endif %}
                        {% elif entry.metadata and entry.metadata.action == 'changed' %}
                            {% if entry.metadata.resume_id or entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}
                                {% set changed_docs = [] %}
                                {% if entry.metadata.resume_id %}{% set _ = changed_docs.append('Resume') %}{% endif %}
                                {% if entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}{% set _ = changed_docs.append('Cover letter') %}{% endif %}
                                {{ changed_docs|join(' and ') }} updated
                            {% else %}
                                Documents updated
                            {% endif %}
                        {% else %}
                            Documents changed
                        {% endif %}
                    {% elif entry.status == 'documents_unlinked' %}
                        Documents removed
                    {% elif entry.status == 'note_added' or entry.status == 'note_updated' or entry.status == 'note_deleted' or entry.change_type == 'note_change' %}
                        {% if entry.status == 'note_added' %}
                            Note Added
                        {% elif entry.status == 'note_updated' %}
                            Note Updated
                        {% elif entry.status == 'note_deleted' %}
                            Note Deleted
                        {% else %}
                            Note Changed
                        {% endif %}
                    {% elif entry.status == 'status_changed' or entry.change_type == 'status_change' or entry.change_type == 'user_update' %}
                        {% if entry.metadata and entry.metadata.new_status %}
                            Status Changed to {{ entry.metadata.new_status|title }}
                        {% else %}
                            Status Changed
                        {% endif %}
                    {% elif entry.status == 'approved' or entry.status == 'rejected' %}
                        Status: {{ entry.status|title }}
                    {% else %}
                        {{ entry.status|replace('_', ' ')|title if entry.status else entry.change_type|replace('_', ' ')|title }}
                    {% endif %}
                </div>
                <div class="status-date">
                    {% if entry.created_at %}
                        {% if entry.created_at.__class__.__name__ == 'str' %}
                            {{ entry.created_at }}
                        {% else %}
                            {% set utc_date = entry.created_at %}
                            {% if entry.created_at.tzinfo %}
                                {% set utc_date = entry.created_at.astimezone(timezone_utc) %}
                            {% endif %}
                            {{ utc_date.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    {% else %}
                        Recently
                    {% endif %}
                </div>
                {% if entry.status == 'status_changed' or entry.change_type == 'status_change' %}
                    {% if entry.metadata and entry.metadata.old_status and entry.metadata.new_status %}
                        <div class="status-reason">Changed from {{ entry.metadata.old_status|title if entry.metadata.old_status else 'None' }} to {{ entry.metadata.new_status|title }}</div>
                    {% elif entry.metadata and entry.metadata.new_status %}
                        <div class="status-reason">Set to {{ entry.metadata.new_status|title }}</div>
                    {% endif %}
                {% elif entry.notes %}
                    <div class="status-reason">{{ entry.notes }}</div>
                {% elif entry.metadata %}
                    <div class="status-reason">
                        {% if entry.metadata.action == 'uploaded' %}
                            {% if entry.metadata.resume_id and entry.metadata.cover_letter_id %}
                                Resume and cover letter uploaded
                            {% elif entry.metadata.resume_id %}
                                Resume uploaded
                            {% elif entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}
                                Cover letter uploaded
                            {% else %}
                                Documents uploaded
                            {% endif %}
                        {% elif entry.metadata.action == 'changed' %}
                            {% if entry.metadata.resume_id or entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}
                                {% set changed_docs = [] %}
                                {% if entry.metadata.resume_id %}{% set changed_docs = changed_docs + ['resume'] %}{% endif %}
                                {% if entry.metadata.cover_letter_id or entry.metadata.has_cover_letter_text %}{% set changed_docs = changed_docs + ['cover letter'] %}{% endif %}
                                {{ changed_docs|join(' and ')|title }} updated
                            {% else %}
                                Documents updated
                            {% endif %}
                        {% elif entry.metadata.resume_id or entry.metadata.cover_letter_id %}
                            {% if entry.metadata.resume_id %}Resume linked{% endif %}
                            {% if entry.metadata.cover_letter_id %}{% if entry.metadata.resume_id %}, {% endif %}Cover letter linked{% endif %}
                        {% elif entry.metadata.enrichment_type %}
                            {% if entry.metadata.enrichment_type == 'system' %}
                                {% set extracted_items = [] %}
                                {% if entry.metadata.skills_extracted %}{% set extracted_items = extracted_items + ['skills' + ((' (' ~ entry.metadata.skills_extracted ~ ')') if entry.metadata.skills_extracted is number else '')] %}{% endif %}
                                {% if entry.metadata.seniority_level %}{% set extracted_items = extracted_items + ['seniority level'] %}{% endif %}
                                {% if entry.metadata.remote_work_type %}{% set extracted_items = extracted_items + ['remote type'] %}{% endif %}
                                {% if entry.metadata.salary_extracted %}{% set extracted_items = extracted_items + ['salary'] %}{% endif %}
                                {% if extracted_items|length > 0 %}
                                    Extracted: {{ extracted_items|join(', ') }}
                                {% else %}
                                    Extracted: skills, seniority level, remote type, salary
                                {% endif %}
                            {% elif entry.metadata.enrichment_type == 'ai_enricher' or entry.metadata.enrichment_type == 'chatgpt_enricher' %}
                                {% set extracted_items = [] %}
                                {% if entry.metadata.summary_extracted %}{% set extracted_items = extracted_items + ['job summary'] %}{% endif %}
                                {% if entry.metadata.skills_extracted %}{% set extracted_items = extracted_items + ['skills' + ((' (' ~ entry.metadata.skills_extracted ~ ')') if entry.metadata.skills_extracted is number else '')] %}{% endif %}
                                {% if entry.metadata.location_extracted %}{% set extracted_items = extracted_items + ['location'] %}{% endif %}
                                {% if entry.metadata.seniority_level %}{% set extracted_items = extracted_items + ['seniority level'] %}{% endif %}
                                {% if entry.metadata.remote_work_type %}{% set extracted_items = extracted_items + ['remote type'] %}{% endif %}
                                {% if entry.metadata.salary_extracted %}{% set extracted_items = extracted_items + ['salary'] %}{% endif %}
                                {% if extracted_items|length > 0 %}
                                    Extracted: {{ extracted_items|join(', ') }}
                                {% else %}
                                    Extracted: job summary, skills, location, seniority level, remote type, salary
                                {% endif %}
                            {% else %}
                                Enrichment fields updated
                            {% endif %}
                        {% elif entry.metadata.campaign_id %}
                            Campaign ID: {{ entry.metadata.campaign_id }}
                        {% elif entry.metadata.note_id %}
                            Note ID: {{ entry.metadata.note_id }}
                        {% endif %}
                    </div>
                {% endif %}
                {% if entry.changed_by %}
                    {% if entry.changed_by == 'system' %}
                        <div class="status-changed-by">
                            <small>Done by: System</small>
                        </div>
                    {% elif entry.changed_by == 'ai_enricher' or entry.changed_by == 'chatgpt_enricher' %}
                        <div class="status-changed-by">
                            <small>Done by: Ai Agent</small>
                        </div>
                    {% elif entry.changed_by == 'user' %}
                        {% if entry.status == 'status_changed' or entry.change_type == 'status_change' %}
                            <div class="status-changed-by">
                                <small>Done by: User</small>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="status-changed-by">
                            <small>Done by: {{ entry.changed_by|replace('_', ' ')|title }}</small>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state">
        <p>No status history available for this job.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
<!-- Resume Upload Modal -->
<div id="resumeUploadModal" class="modal-overlay" style="display: none !important;">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Resume</h3>
            <button class="modal-close" onclick="closeResumeUploadModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
        
        <!-- Tabs for Upload vs Select -->
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchResumeTab('upload')">Upload New</button>
            <button class="modal-tab" onclick="switchResumeTab('select')">Select Existing</button>
        </div>
        
        <!-- Upload New Tab -->
        <div id="resumeUploadTab" class="modal-tab-content">
            <form method="POST" action="{{ url_for('upload_resume', job_id=job.jsearch_job_id) }}" 
                  enctype="multipart/form-data" 
                  id="resumeUploadForm"
                  onsubmit="return uploadResume(event);">
                <div class="form-group">
                    <label for="resume_name">Resume Name:</label>
                    <input type="text" name="resume_name" id="resume_name" class="form-control" 
                           placeholder="e.g., Data Engineer Resume v2">
                </div>
                <div class="form-group">
                    <label for="resume_file">Select File (PDF or DOCX, max 5MB):</label>
                    <input type="file" name="file" id="resume_file" accept=".pdf,.docx" required>
                </div>
                <input type="hidden" name="link_to_job" value="true">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Upload</button>
                    <button type="button" class="btn btn-secondary" onclick="closeResumeUploadModal()">Cancel</button>
                </div>
            </form>
        </div>
        
        <!-- Select Existing Tab -->
        <div id="resumeSelectTab" class="modal-tab-content" style="display: none;">
            <div class="form-group">
                <label for="resumeSelectModal">Select an existing resume:</label>
                <select class="form-control" name="resume_id" id="resumeSelectModal">
                    <option value="">Choose a resume...</option>
                    {% for resume in user_resumes %}
                    <option value="{{ resume.resume_id }}">{{ resume.resume_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="linkResumeFromModal()">Link Resume</button>
                <button type="button" class="btn btn-secondary" onclick="closeResumeUploadModal()">Cancel</button>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Cover Letter Modal -->
<div id="coverLetterModal" class="modal-overlay" style="display: none !important;">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Cover Letter</h3>
            <button class="modal-close" onclick="closeCoverLetterModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
        
        <!-- Tabs for Create vs Select -->
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchCoverLetterTab('create')">Create New</button>
            <button class="modal-tab" onclick="switchCoverLetterTab('select')">Select Existing</button>
        </div>
        
        <!-- Create New Tab -->
        <div id="coverLetterCreateTab" class="modal-tab-content">
            <form method="POST" action="{{ url_for('create_cover_letter', job_id=job.jsearch_job_id) }}" 
                  enctype="multipart/form-data" 
                  id="coverLetterForm"
                  onsubmit="return createCoverLetter(event);">
                <div class="form-group">
                    <label for="cover_letter_name">Cover Letter Name:</label>
                    <input type="text" name="cover_letter_name" id="cover_letter_name" class="form-control" 
                           placeholder="e.g., Cover Letter for {{ job.company_name or 'Company' }}" required>
                </div>
                <div class="form-group">
                    <label>Create as:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="cover_letter_type" value="text" checked onchange="toggleCoverLetterType()"> Text</label>
                        <label><input type="radio" name="cover_letter_type" value="file" onchange="toggleCoverLetterType()"> File Upload</label>
                    </div>
                </div>
                <div class="form-group" id="coverLetterTextGroup">
                    <label for="cover_letter_text">Cover Letter Text:</label>
                    <textarea name="cover_letter_text" id="cover_letter_text" class="form-control" rows="10" 
                              placeholder="Dear Hiring Manager,&#10;&#10;I am writing to express my interest..."></textarea>
                </div>
                <div class="form-group" id="coverLetterFileGroup" style="display: none;">
                    <label for="cover_letter_file">Select File (PDF or DOCX, max 5MB):</label>
                    <input type="file" name="file" id="cover_letter_file" accept=".pdf,.docx">
                </div>
                <input type="hidden" name="link_to_job" value="true">
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCoverLetterModal()">Cancel</button>
                </div>
            </form>
        </div>
        
        <!-- Select Existing Tab -->
        <div id="coverLetterSelectTab" class="modal-tab-content" style="display: none;">
            <div class="form-group">
                <label for="coverLetterSelectModal">Select an existing cover letter:</label>
                <select class="form-control" name="cover_letter_id" id="coverLetterSelectModal">
                    <option value="">Choose a cover letter...</option>
                    {% for cover_letter in user_cover_letters %}
                    <option value="{{ cover_letter.cover_letter_id }}">{{ cover_letter.cover_letter_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" onclick="linkCoverLetterFromModal()">Link Cover Letter</button>
                <button type="button" class="btn btn-secondary" onclick="closeCoverLetterModal()">Cancel</button>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- All Notes Modal -->
<div class="modal-overlay" id="allNotesModal">
    <div class="modal" style="max-width: 700px; max-height: 90vh;">
        <div class="modal-header">
            <h3>All Notes</h3>
            <button class="modal-close" onclick="closeAllNotesModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div id="allNotesList" style="max-height: 60vh; overflow-y: auto;">
                <div class="notes-loading" style="text-align: center; padding: var(--spacing-md);">
                    <i class="fas fa-spinner fa-spin"></i> Loading notes...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Status History Modal -->
<div class="modal-overlay" id="allHistoryModal">
    <div class="modal" style="max-width: 800px; max-height: 90vh;">
        <div class="modal-header">
            <h3>All Status History</h3>
            <button class="modal-close" onclick="closeAllHistoryModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div id="allHistoryList" style="max-height: 70vh; overflow-y: auto;">
                <div class="status-history-loading" style="text-align: center; padding: var(--spacing-md);">
                    <i class="fas fa-spinner fa-spin"></i> Loading history...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Ranking Explanation Modal -->
<div class="modal-overlay" id="rankingModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Job Ranking Breakdown</h3>
            <button class="modal-close" onclick="closeRankingModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div>
                <strong id="modalCompanyName"></strong> - <span id="modalJobPosition"></span>
            </div>
            <div class="ranking-score">
                Score: <span id="modalScore">0</span>
            </div>
            <div class="ranking-breakdown">
                <h4>Ranking Breakdown</h4>
                <div id="rankingDetails"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/jobDetails.js') }}"></script>
<script>
// Multi-note functionality for job details page
let currentJobId = '{{ job.jsearch_job_id }}';
const MAX_NOTES_DISPLAYED = 3; // Number of notes to show on the page
const MAX_NOTE_TEXT_LENGTH = 300; // Maximum characters to display per note before truncating

// Load notes when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (currentJobId) {
        loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
    }
});

function loadNotes(jobId, limit = MAX_NOTES_DISPLAYED) {
    const notesList = document.getElementById('notesList');
    notesList.innerHTML = '<div class="notes-loading" style="text-align: center; padding: var(--spacing-md);"><i class="fas fa-spinner fa-spin"></i> Loading notes...</div>';

    fetch(`/jobs/${encodeURIComponent(jobId)}/note`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                notesList.innerHTML = `<div class="error-message" style="color: var(--color-error); padding: var(--spacing-md);">Error: ${data.error}</div>`;
                return;
            }

            const allNotes = data.notes || [];
            if (allNotes.length === 0) {
                notesList.innerHTML = '<div class="empty-state" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-secondary);">No notes yet. Add your first note below!</div>';
                document.getElementById('viewAllNotesBtn').style.display = 'none';
                return;
            }

            // Store all notes globally for modal
            window.allNotes = allNotes;

            // Show "View All Notes" button if there are more notes than the limit
            const viewAllBtn = document.getElementById('viewAllNotesBtn');
            if (allNotes.length > limit) {
                viewAllBtn.style.display = 'inline-block';
                viewAllBtn.innerHTML = `<i class="fas fa-list"></i> View All Notes (${allNotes.length})`;
            } else {
                viewAllBtn.style.display = 'none';
            }

            // Store original note texts for cancel functionality
            window.noteOriginalTexts = window.noteOriginalTexts || {};
            
            // Reverse the array so newest notes appear at the bottom
            const reversedNotes = [...allNotes].reverse();
            
            // Limit to last N notes (most recent notes at the bottom)
            const displayedNotes = reversedNotes.slice(-limit);
            
            notesList.innerHTML = displayedNotes.map(note => {
                const createdDate = new Date(note.created_at).toLocaleString();
                const updatedDate = new Date(note.updated_at).toLocaleString();
                const isModified = note.is_modified;
                const noteId = note.note_id;
                const fullNoteText = note.note_text.trimStart();
                const isLongNote = fullNoteText.length > MAX_NOTE_TEXT_LENGTH;
                const truncatedText = isLongNote ? fullNoteText.substring(0, MAX_NOTE_TEXT_LENGTH) + '...' : fullNoteText;
                const noteText = escapeHtml(truncatedText);
                const fullNoteTextEscaped = escapeHtml(fullNoteText);
                
                // Store original text for cancel edit functionality
                window.noteOriginalTexts[noteId] = fullNoteText;

                return `
                    <div class="note-item" data-note-id="${noteId}" style="border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); margin-bottom: var(--spacing-md); background: var(--color-background-secondary);">
                        <div class="note-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                            <div class="note-meta" style="flex: 1;">
                                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                    Created: ${createdDate}
                                    ${isModified ? `<span class="edited-badge" style="margin-left: var(--spacing-sm); padding: 2px 6px; background: var(--color-warning); color: white; border-radius: 3px; font-size: 0.75rem;"><i class="fas fa-edit"></i> Edited</span>` : ''}
                                </div>
                                ${isModified ? `<div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 2px;">Last modified: ${updatedDate}</div>` : ''}
                            </div>
                            <div class="note-actions" style="display: flex; gap: var(--spacing-xs);">
                                <button class="btn btn-small btn-secondary" onclick="editNote(${noteId})" title="Edit note">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-danger" onclick="deleteNote(${noteId})" title="Delete note">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="note-content" id="note-content-${noteId}" style="white-space: pre-wrap; word-wrap: break-word; text-align: left; padding: 0; margin: 0; text-indent: 0; list-style: none;"><span id="note-text-${noteId}">${noteText}</span>${isLongNote ? `<button class="btn-link expand-note-btn" data-note-id="${noteId}" data-full-text="${fullNoteTextEscaped.replace(/"/g, '&quot;')}" data-expanded="false" id="expand-note-${noteId}" style="color: var(--color-primary); text-decoration: underline; cursor: pointer; margin-left: var(--spacing-xs); font-size: 0.875rem; display: inline;">Show more</button>` : ''}
                        </div>
                        <div class="note-edit-form" id="note-edit-${noteId}" style="display: none; margin-top: var(--spacing-sm);">
                            <textarea id="note-edit-text-${noteId}" rows="3" style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius);">${escapeHtml(fullNoteText)}</textarea>
                            <div style="display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-sm);">
                                <button class="btn btn-small btn-primary" onclick="saveNoteEdit(${noteId})">Save</button>
                                <button class="btn btn-small btn-secondary" onclick="cancelNoteEdit(${noteId})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading notes:', error);
            notesList.innerHTML = `<div class="error-message" style="color: var(--color-error); padding: var(--spacing-md);">Error loading notes. Please try again.</div>`;
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleNoteText(noteId, fullText, isExpanded) {
    const noteTextElement = document.getElementById(`note-text-${noteId}`);
    const expandButton = document.getElementById(`expand-note-${noteId}`);
    
    if (!noteTextElement || !expandButton) {
        return;
    }
    
    if (isExpanded) {
        // Show full text
        noteTextElement.textContent = fullText;
        expandButton.textContent = 'Show less';
        expandButton.setAttribute('data-expanded', 'true');
    } else {
        // Show truncated text
        const truncatedText = fullText.length > MAX_NOTE_TEXT_LENGTH 
            ? fullText.substring(0, MAX_NOTE_TEXT_LENGTH) + '...' 
            : fullText;
        noteTextElement.textContent = truncatedText;
        expandButton.textContent = 'Show more';
        expandButton.setAttribute('data-expanded', 'false');
    }
}

// Event delegation for expand/collapse buttons
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('expand-note-btn')) {
            const button = event.target;
            const noteId = button.getAttribute('data-note-id');
            const fullText = button.getAttribute('data-full-text').replace(/&quot;/g, '"');
            const isExpanded = button.getAttribute('data-expanded') === 'true';
            toggleNoteText(parseInt(noteId), fullText, !isExpanded);
        }
    });
});

function showNoteMessage(message, type = 'info') {
    // Remove any existing message
    const existingMsg = document.getElementById('note-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.id = 'note-message';
    messageDiv.style.cssText = `
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border-radius: var(--border-radius);
        ${type === 'error' ? 'background: #fee; color: #c33; border: 1px solid #fcc;' : ''}
        ${type === 'success' ? 'background: #efe; color: #3c3; border: 1px solid #cfc;' : ''}
        ${type === 'info' ? 'background: #eef; color: #33c; border: 1px solid #ccf;' : ''}
    `;
    messageDiv.textContent = message;
    
    // Insert at top of notes section
    const notesSection = document.querySelector('.comments-section');
    if (notesSection) {
        const notesListContainer = document.getElementById('notesListContainer');
        if (notesListContainer) {
            notesSection.insertBefore(messageDiv, notesListContainer);
        } else {
            notesSection.appendChild(messageDiv);
        }
        
        // Auto-remove after 5 seconds for success/info messages
        if (type !== 'error') {
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    }
}

function showNoteMessageInModal(message, type = 'info') {
    // Remove any existing message in modal
    const existingMsg = document.getElementById('modal-note-message');
    if (existingMsg) {
        existingMsg.remove();
    }
    
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.id = 'modal-note-message';
    messageDiv.style.cssText = `
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        border-radius: var(--border-radius);
        ${type === 'error' ? 'background: #fee; color: #c33; border: 1px solid #fcc;' : ''}
        ${type === 'success' ? 'background: #efe; color: #3c3; border: 1px solid #cfc;' : ''}
        ${type === 'info' ? 'background: #eef; color: #33c; border: 1px solid #ccf;' : ''}
    `;
    messageDiv.textContent = message;
    
    // Insert at top of modal content
    const modalContent = document.querySelector('#allNotesModal .modal-content');
    if (modalContent) {
        modalContent.insertBefore(messageDiv, modalContent.firstChild);
        
        // Auto-remove after 5 seconds for success/info messages
        if (type !== 'error') {
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    }
}

function addNewNote() {
    const noteText = document.getElementById('note_text').value.trim();
    if (!noteText) {
        showNoteMessage('Please enter a note', 'error');
        return;
    }

    const button = document.querySelector('button[onclick*="addNewNote"]');
    const originalText = button?.textContent || 'Add Note';
    if (button) {
        button.disabled = true;
        button.textContent = 'Adding...';
    }

    const formData = new FormData();
    formData.append('note_text', noteText);

    fetch(`/jobs/${encodeURIComponent(currentJobId)}/note`, {
        method: 'POST',
        body: formData
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            document.getElementById('note_text').value = '';
            loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
            showNoteMessage('Note added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error adding note:', error);
            const errorMsg = error?.error || error?.message || 'Error adding note. Please try again.';
            showNoteMessage(errorMsg, 'error');
        })
        .finally(() => {
            if (button) {
                button.disabled = false;
                button.textContent = originalText;
            }
        });
}

function editNote(noteId) {
    document.getElementById(`note-content-${noteId}`).style.display = 'none';
    document.getElementById(`note-edit-${noteId}`).style.display = 'block';
}

function cancelNoteEdit(noteId) {
    document.getElementById(`note-content-${noteId}`).style.display = 'block';
    document.getElementById(`note-edit-${noteId}`).style.display = 'none';
    // Reset textarea to original value from stored data
    if (window.noteOriginalTexts && window.noteOriginalTexts[noteId]) {
        document.getElementById(`note-edit-text-${noteId}`).value = window.noteOriginalTexts[noteId];
    }
}

function saveNoteEdit(noteId) {
    const noteText = document.getElementById(`note-edit-text-${noteId}`).value.trim();
    if (!noteText) {
        showNoteMessage('Note text cannot be empty', 'error');
        return;
    }

    const button = document.querySelector(`button[onclick*="saveNoteEdit(${noteId})"]`);
    const originalText = button?.textContent || 'Save';
    if (button) {
        button.disabled = true;
        button.textContent = 'Saving...';
    }

    fetch(`/jobs/${encodeURIComponent(currentJobId)}/note/${noteId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ note_text: noteText })
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
            showNoteMessage('Note updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating note:', error);
            const errorMsg = error?.error || error?.message || 'Error updating note. Please try again.';
            showNoteMessage(errorMsg, 'error');
        })
        .finally(() => {
            if (button) {
                button.disabled = false;
                button.textContent = originalText;
            }
        });
}

function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) {
        return;
    }

    const button = document.querySelector(`button[onclick*="deleteNote(${noteId})"]`);
    const originalHTML = button ? button.innerHTML : '<i class="fas fa-trash"></i>';
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    fetch(`/jobs/${encodeURIComponent(currentJobId)}/note/${noteId}`, {
        method: 'DELETE'
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
            showNoteMessage('Note deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting note:', error);
            const errorMsg = error?.error || error?.message || 'Error deleting note. Please try again.';
            showNoteMessage(errorMsg, 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        });
}

// Modal functions for viewing all notes
function openAllNotesModal() {
    const modal = document.getElementById('allNotesModal');
    modal.classList.add('active');
    modal.style.display = 'flex';
    loadAllNotes();
}

function closeAllNotesModal() {
    const modal = document.getElementById('allNotesModal');
    modal.classList.remove('active');
    modal.style.display = 'none';
}

function loadAllNotes() {
    const allNotesList = document.getElementById('allNotesList');
    allNotesList.innerHTML = '<div class="notes-loading" style="text-align: center; padding: var(--spacing-md);"><i class="fas fa-spinner fa-spin"></i> Loading notes...</div>';

    // Use cached notes if available, otherwise fetch
    if (window.allNotes && window.allNotes.length > 0) {
        renderAllNotes(window.allNotes);
    } else {
        fetch(`/jobs/${encodeURIComponent(currentJobId)}/note`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    allNotesList.innerHTML = `<div class="error-message" style="color: var(--color-error); padding: var(--spacing-md);">Error: ${data.error}</div>`;
                    return;
                }
                window.allNotes = data.notes || [];
                renderAllNotes(window.allNotes);
            })
            .catch(error => {
                console.error('Error loading notes:', error);
                allNotesList.innerHTML = `<div class="error-message" style="color: var(--color-error); padding: var(--spacing-md);">Error loading notes. Please try again.</div>`;
            });
    }
}

function renderAllNotes(notes) {
    const allNotesList = document.getElementById('allNotesList');
    
    if (notes.length === 0) {
        allNotesList.innerHTML = '<div class="empty-state" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-secondary);">No notes yet.</div>';
        return;
    }

    // Store original note texts for cancel functionality
    window.noteOriginalTexts = window.noteOriginalTexts || {};
    
    // Reverse the array so newest notes appear at the bottom
    const reversedNotes = [...notes].reverse();
    
    allNotesList.innerHTML = reversedNotes.map(note => {
        const createdDate = new Date(note.created_at).toLocaleString();
        const updatedDate = new Date(note.updated_at).toLocaleString();
        const isModified = note.is_modified;
        const noteId = note.note_id;
        const fullNoteText = note.note_text.trimStart();
        const isLongNote = fullNoteText.length > MAX_NOTE_TEXT_LENGTH;
        const truncatedText = isLongNote ? fullNoteText.substring(0, MAX_NOTE_TEXT_LENGTH) + '...' : fullNoteText;
        const noteText = escapeHtml(truncatedText);
        const fullNoteTextEscaped = escapeHtml(fullNoteText);
        
        // Store original text for cancel edit functionality
        window.noteOriginalTexts[noteId] = fullNoteText;

        return `
            <div class="note-item" data-note-id="${noteId}" style="border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); margin-bottom: var(--spacing-md); background: var(--color-background-secondary);">
                <div class="note-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                    <div class="note-meta" style="flex: 1;">
                        <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                            Created: ${createdDate}
                            ${isModified ? `<span class="edited-badge" style="margin-left: var(--spacing-sm); padding: 2px 6px; background: var(--color-warning); color: white; border-radius: 3px; font-size: 0.75rem;"><i class="fas fa-edit"></i> Edited</span>` : ''}
                        </div>
                        ${isModified ? `<div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 2px;">Last modified: ${updatedDate}</div>` : ''}
                    </div>
                    <div class="note-actions" style="display: flex; gap: var(--spacing-xs);">
                        <button class="btn btn-small btn-secondary" onclick="editNoteInModal(${noteId})" title="Edit note">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteNoteInModal(${noteId})" title="Delete note">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="note-content" id="modal-note-content-${noteId}" style="white-space: pre-wrap; word-wrap: break-word; text-align: left; padding: 0; margin: 0; text-indent: 0; list-style: none;"><span id="modal-note-text-${noteId}">${noteText}</span>${isLongNote ? `<button class="btn-link expand-note-modal-btn" data-note-id="${noteId}" data-full-text="${fullNoteTextEscaped.replace(/"/g, '&quot;')}" data-expanded="false" id="modal-expand-note-${noteId}" style="color: var(--color-primary); text-decoration: underline; cursor: pointer; margin-left: var(--spacing-xs); font-size: 0.875rem; display: inline;">Show more</button>` : ''}
                </div>
                <div class="note-edit-form" id="modal-note-edit-${noteId}" style="display: none; margin-top: var(--spacing-sm);">
                    <textarea id="modal-note-edit-text-${noteId}" rows="3" style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius);">${escapeHtml(fullNoteText)}</textarea>
                    <div style="display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-sm);">
                        <button class="btn btn-small btn-primary" onclick="saveNoteEditInModal(${noteId})">Save</button>
                        <button class="btn btn-small btn-secondary" onclick="cancelNoteEditInModal(${noteId})">Cancel</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function editNoteInModal(noteId) {
    document.getElementById(`modal-note-content-${noteId}`).style.display = 'none';
    document.getElementById(`modal-note-edit-${noteId}`).style.display = 'block';
}

function cancelNoteEditInModal(noteId) {
    document.getElementById(`modal-note-content-${noteId}`).style.display = 'block';
    document.getElementById(`modal-note-edit-${noteId}`).style.display = 'none';
    if (window.noteOriginalTexts && window.noteOriginalTexts[noteId]) {
        document.getElementById(`modal-note-edit-text-${noteId}`).value = window.noteOriginalTexts[noteId];
    }
}

function toggleNoteTextInModal(noteId, fullText, isExpanded) {
    const noteTextElement = document.getElementById(`modal-note-text-${noteId}`);
    const expandButton = document.getElementById(`modal-expand-note-${noteId}`);
    
    if (!noteTextElement || !expandButton) {
        return;
    }
    
    if (isExpanded) {
        // Show full text
        noteTextElement.textContent = fullText;
        expandButton.textContent = 'Show less';
        expandButton.setAttribute('data-expanded', 'true');
    } else {
        // Show truncated text
        const truncatedText = fullText.length > MAX_NOTE_TEXT_LENGTH 
            ? fullText.substring(0, MAX_NOTE_TEXT_LENGTH) + '...' 
            : fullText;
        noteTextElement.textContent = truncatedText;
        expandButton.textContent = 'Show more';
        expandButton.setAttribute('data-expanded', 'false');
    }
}

// Event delegation for expand/collapse buttons in modal
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('expand-note-modal-btn')) {
            const button = event.target;
            const noteId = button.getAttribute('data-note-id');
            const fullText = button.getAttribute('data-full-text').replace(/&quot;/g, '"');
            const isExpanded = button.getAttribute('data-expanded') === 'true';
            toggleNoteTextInModal(parseInt(noteId), fullText, !isExpanded);
        }
    });
});

function saveNoteEditInModal(noteId) {
    const noteText = document.getElementById(`modal-note-edit-text-${noteId}`).value.trim();
    if (!noteText) {
        showNoteMessageInModal('Note text cannot be empty', 'error');
        return;
    }

    const button = document.querySelector(`button[onclick*="saveNoteEditInModal(${noteId})"]`);
    const originalText = button?.textContent || 'Save';
    if (button) {
        button.disabled = true;
        button.textContent = 'Saving...';
    }

    fetch(`/jobs/${encodeURIComponent(currentJobId)}/note/${noteId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ note_text: noteText })
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            loadAllNotes();
            loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
            showNoteMessageInModal('Note updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating note:', error);
            showNoteMessageInModal(error?.error || error?.message || 'Error updating note. Please try again.', 'error');
        })
        .finally(() => {
            if (button) {
                button.disabled = false;
                button.textContent = originalText;
            }
        });
}

function deleteNoteInModal(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) {
        return;
    }

    const button = document.querySelector(`button[onclick*="deleteNoteInModal(${noteId})"]`);
    const originalHTML = button ? button.innerHTML : '<i class="fas fa-trash"></i>';
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }

    fetch(`/jobs/${encodeURIComponent(currentJobId)}/note/${noteId}`, {
        method: 'DELETE'
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => Promise.reject(data));
            }
            return response.json();
        })
        .then(data => {
            loadAllNotes();
            loadNotes(currentJobId, MAX_NOTES_DISPLAYED);
            showNoteMessageInModal('Note deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting note:', error);
            showNoteMessageInModal(error?.error || error?.message || 'Error deleting note. Please try again.', 'error');
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        });
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const allNotesModal = document.getElementById('allNotesModal');
    if (allNotesModal) {
        allNotesModal.addEventListener('click', function(event) {
            if (event.target === allNotesModal) {
                closeAllNotesModal();
            }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && allNotesModal.classList.contains('active')) {
                closeAllNotesModal();
            }
        });
    }

    // Status History Modal event handlers
    const allHistoryModal = document.getElementById('allHistoryModal');
    if (allHistoryModal) {
        allHistoryModal.addEventListener('click', function(event) {
            if (event.target === allHistoryModal) {
                closeAllHistoryModal();
            }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && allHistoryModal.classList.contains('active')) {
                closeAllHistoryModal();
            }
        });
    }
});

// Status History Modal Functions
function openAllHistoryModal() {
    const modal = document.getElementById('allHistoryModal');
    modal.classList.add('active');
    modal.style.display = 'flex';
    loadAllHistory();
}

function closeAllHistoryModal() {
    const modal = document.getElementById('allHistoryModal');
    modal.classList.remove('active');
    modal.style.display = 'none';
}

function loadAllHistory() {
    const allHistoryList = document.getElementById('allHistoryList');
    allHistoryList.innerHTML = '<div class="status-history-loading" style="text-align: center; padding: var(--spacing-md);"><i class="fas fa-spinner fa-spin"></i> Loading history...</div>';

    // Use cached history if available, otherwise use template data
    if (window.allStatusHistory && window.allStatusHistory.length > 0) {
        renderAllHistory(window.allStatusHistory);
    } else {
        // Try to fetch from API or use template data
        fetch(`/api/jobs/${encodeURIComponent(currentJobId)}/status/history`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load history');
                }
                return response.json();
            })
            .then(data => {
                window.allStatusHistory = data.history || [];
                renderAllHistory(window.allStatusHistory);
            })
            .catch(error => {
                console.error('Error loading history:', error);
                // Fallback to template data if available
                {% if status_history %}
                window.allStatusHistory = {{ status_history | tojson }};
                renderAllHistory(window.allStatusHistory);
                {% else %}
                allHistoryList.innerHTML = '<div class="error-message" style="color: var(--color-error); padding: var(--spacing-md);">Error loading history. Please try again.</div>';
                {% endif %}
            });
    }
}

function renderAllHistory(history) {
    const allHistoryList = document.getElementById('allHistoryList');
    
    if (!history || history.length === 0) {
        allHistoryList.innerHTML = '<div class="empty-state" style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-secondary);">No status history available.</div>';
        return;
    }

    allHistoryList.innerHTML = '<ul class="status-history">' + history.map(entry => {
        const statusName = formatStatusName(entry);
        const statusDate = formatStatusDate(entry.created_at);
        const statusReason = formatStatusReason(entry);
        
        let changedBy = '';
        if (entry.changed_by) {
            if (entry.changed_by === 'system') {
                changedBy = '<div class="status-changed-by"><small>Done by: System</small></div>';
            } else if (entry.changed_by === 'ai_enricher' || entry.changed_by === 'chatgpt_enricher') {
                changedBy = '<div class="status-changed-by"><small>Done by: Ai Agent</small></div>';
            } else if (entry.changed_by === 'user') {
                if (entry.status === 'status_changed' || entry.change_type === 'status_change') {
                    changedBy = '<div class="status-changed-by"><small>Done by: User</small></div>';
                }
            } else {
                changedBy = `<div class="status-changed-by"><small>Done by: ${escapeHtml(entry.changed_by.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</small></div>`;
            }
        }

        return `
            <li class="status-history-item">
                <div class="status-info">
                    <div class="status-name">${escapeHtml(statusName)}</div>
                    <div class="status-date">${statusDate}</div>
                    ${statusReason ? `<div class="status-reason">${escapeHtml(statusReason)}</div>` : ''}
                    ${changedBy}
                </div>
            </li>
        `;
    }).join('') + '</ul>';
}

function formatStatusName(entry) {
    if (entry.status === 'job_found' || entry.status === 'found' || entry.change_type === 'extraction') {
        return 'Job found';
    } else if (entry.status === 'updated_by_system' || entry.changed_by === 'system') {
        return 'Job posting enriched and ranked';
    } else if (entry.status === 'updated_by_ai' || entry.changed_by === 'ai_enricher' || entry.changed_by === 'chatgpt_enricher') {
        return 'Job posting enriched and reranked';
    } else if (entry.status === 'documents_uploaded' || entry.status === 'documents_linked' || entry.change_type === 'document_change') {
        if (entry.metadata && entry.metadata.action === 'uploaded') {
            if (entry.metadata.resume_id && entry.metadata.cover_letter_id) {
                return 'Resume and cover letter uploaded';
            } else if (entry.metadata.resume_id) {
                return 'Resume uploaded';
            } else if (entry.metadata.cover_letter_id || entry.metadata.has_cover_letter_text) {
                return 'Cover letter uploaded';
            } else {
                return 'Documents uploaded';
            }
        } else if (entry.metadata && entry.metadata.action === 'changed') {
            const changedDocs = [];
            if (entry.metadata.resume_id) changedDocs.push('Resume');
            if (entry.metadata.cover_letter_id || entry.metadata.has_cover_letter_text) changedDocs.push('Cover letter');
            if (changedDocs.length > 0) {
                return changedDocs.join(' and ') + ' updated';
            } else {
                return 'Documents updated';
            }
        } else {
            return 'Documents changed';
        }
    } else if (entry.status === 'documents_unlinked') {
        return 'Documents removed';
    } else if (entry.status === 'note_added') {
        return 'Note Added';
    } else if (entry.status === 'note_updated') {
        return 'Note Updated';
    } else if (entry.status === 'note_deleted') {
        return 'Note Deleted';
    } else if (entry.status === 'status_changed' || entry.change_type === 'status_change' || entry.change_type === 'user_update') {
        if (entry.metadata && entry.metadata.new_status) {
            return `Status Changed to ${entry.metadata.new_status.charAt(0).toUpperCase() + entry.metadata.new_status.slice(1)}`;
        } else {
            return 'Status Changed';
        }
    } else if (entry.status === 'approved' || entry.status === 'rejected') {
        return `Status: ${entry.status.charAt(0).toUpperCase() + entry.status.slice(1)}`;
    } else {
        return entry.status ? entry.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : entry.change_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
}

function formatStatusDate(createdAt) {
    if (!createdAt) return 'Recently';
    try {
        const date = new Date(createdAt);
        // Use UTC methods to match server-side UTC formatting
        const year = date.getUTCFullYear();
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const day = String(date.getUTCDate()).padStart(2, '0');
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    } catch (e) {
        return createdAt;
    }
}

function formatStatusReason(entry) {
    if (entry.status === 'status_changed' || entry.change_type === 'status_change') {
        if (entry.metadata && entry.metadata.old_status && entry.metadata.new_status) {
            const oldStatus = entry.metadata.old_status ? entry.metadata.old_status.charAt(0).toUpperCase() + entry.metadata.old_status.slice(1) : 'None';
            const newStatus = entry.metadata.new_status.charAt(0).toUpperCase() + entry.metadata.new_status.slice(1);
            return `Changed from ${oldStatus} to ${newStatus}`;
        } else if (entry.metadata && entry.metadata.new_status) {
            const newStatus = entry.metadata.new_status.charAt(0).toUpperCase() + entry.metadata.new_status.slice(1);
            return `Set to ${newStatus}`;
        }
    } else if (entry.notes) {
        return entry.notes;
    } else if (entry.metadata) {
        if (entry.metadata.action === 'uploaded') {
            if (entry.metadata.resume_id && entry.metadata.cover_letter_id) {
                return 'Resume and cover letter uploaded';
            } else if (entry.metadata.resume_id) {
                return 'Resume uploaded';
            } else if (entry.metadata.cover_letter_id || entry.metadata.has_cover_letter_text) {
                return 'Cover letter uploaded';
            } else {
                return 'Documents uploaded';
            }
        } else if (entry.metadata.action === 'changed') {
            const changedDocs = [];
            if (entry.metadata.resume_id) changedDocs.push('Resume');
            if (entry.metadata.cover_letter_id || entry.metadata.has_cover_letter_text) changedDocs.push('Cover letter');
            if (changedDocs.length > 0) {
                return changedDocs.join(' and ') + ' updated';
            } else {
                return 'Documents updated';
            }
        } else if (entry.metadata.resume_id || entry.metadata.cover_letter_id) {
            let parts = [];
            if (entry.metadata.resume_id) parts.push('Resume linked');
            if (entry.metadata.cover_letter_id) parts.push('Cover letter linked');
            return parts.join(', ');
        } else if (entry.metadata.enrichment_type) {
            if (entry.metadata.enrichment_type === 'system') {
                let fields = [];
                if (entry.metadata.skills_extracted !== undefined) {
                    const skillsCount = typeof entry.metadata.skills_extracted === 'number' 
                        ? ` (${entry.metadata.skills_extracted})` 
                        : '';
                    fields.push('skills' + skillsCount);
                }
                if (entry.metadata.seniority_level) fields.push('seniority level');
                if (entry.metadata.remote_work_type) fields.push('remote type');
                if (entry.metadata.salary_extracted) fields.push('salary');
                
                if (fields.length > 0) {
                    return 'Extracted: ' + fields.join(', ');
                } else {
                    return 'Extracted: skills, seniority level, remote type, salary';
                }
            } else if (entry.metadata.enrichment_type === 'ai_enricher' || entry.metadata.enrichment_type === 'chatgpt_enricher') {
                let fields = [];
                if (entry.metadata.summary_extracted) fields.push('job summary');
                if (entry.metadata.skills_extracted !== undefined) {
                    const skillsCount = typeof entry.metadata.skills_extracted === 'number' 
                        ? ` (${entry.metadata.skills_extracted})` 
                        : '';
                    fields.push('skills' + skillsCount);
                }
                if (entry.metadata.location_extracted) fields.push('location');
                if (entry.metadata.seniority_level) fields.push('seniority level');
                if (entry.metadata.remote_work_type) fields.push('remote type');
                if (entry.metadata.salary_extracted) fields.push('salary');
                
                if (fields.length > 0) {
                    return 'Extracted: ' + fields.join(', ');
                } else {
                    return 'Extracted: job summary, skills, location, seniority level, remote type, salary';
                }
            } else {
                return 'Enrichment fields updated';
            }
        } else if (entry.metadata.enrichment_fields) {
            return 'Enrichment fields updated';
        } else if (entry.metadata.campaign_id) {
            return `Campaign ID: ${entry.metadata.campaign_id}`;
        } else if (entry.metadata.note_id) {
            return `Note ID: ${entry.metadata.note_id}`;
        }
    }
    return '';
}

// Store status history from template on page load
{% if status_history %}
window.allStatusHistory = {{ status_history | tojson }};
{% endif %}

</script>
{% endblock %}
