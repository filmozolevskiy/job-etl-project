{% extends "base.html" %}

{% block title %}{{ campaign.campaign_name }} - Campaign Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Campaign: {{ campaign.campaign_name }}
        <span style="float: right;">
            {% if campaign.is_active %}
                <span class="badge badge-success">Active</span>
            {% else %}
                <span class="badge badge-secondary">Inactive</span>
            {% endif %}
        </span>
    </div>
    
    <div style="margin-bottom: 1rem;">
        <a href="{{ url_for('edit_campaign', campaign_id=campaign.campaign_id) }}" class="btn btn-primary">Edit Campaign</a>
        <a href="{{ url_for('view_jobs', campaign_id=campaign.campaign_id) }}" class="btn btn-primary">View Jobs</a>
        <form method="POST" action="{{ url_for('trigger_campaign_dag', campaign_id=campaign.campaign_id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success" onclick="return confirm('Trigger DAG run for this campaign?');">Run DAG</button>
        </form>
        <form method="POST" action="{{ url_for('toggle_active', campaign_id=campaign.campaign_id) }}" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
                {% if campaign.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>
        </form>
        <form method="POST" action="{{ url_for('delete_campaign', campaign_id=campaign.campaign_id) }}" 
              style="display: inline;"
              onsubmit="return confirm('Are you sure you want to delete this campaign? This action cannot be undone.');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
    
    <h3>Search Criteria</h3>
    <table style="margin-top: 1rem;">
        {% if current_user.is_admin and campaign.username %}
        <tr>
            <th style="width: 200px;">Owner</th>
            <td>{{ campaign.username }}</td>
        </tr>
        {% endif %}
        <tr>
            <th style="width: 200px;">Query</th>
            <td>{{ campaign.query }}</td>
        </tr>
        <tr>
            <th>Location</th>
            <td>{{ campaign.location or '-' }}</td>
        </tr>
        <tr>
            <th>Country</th>
            <td>{{ campaign.country or '-' }}</td>
        </tr>
        <tr>
            <th>Date Window</th>
            <td>{{ campaign.date_window or '-' }}</td>
        </tr>
        <tr>
            <th>Skills</th>
            <td>{{ campaign.skills or '-' }}</td>
        </tr>
        <tr>
            <th>Salary Range</th>
            <td>
                {% if campaign.min_salary or campaign.max_salary %}
                    {% if campaign.currency %}{{ campaign.currency }}{% else %}USD{% endif %} 
                    {% if campaign.min_salary %}{{ "%.0f"|format(campaign.min_salary) }}{% endif %}
                    {% if campaign.min_salary and campaign.max_salary %} - {% endif %}
                    {% if campaign.max_salary %}{{ "%.0f"|format(campaign.max_salary) }}{% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Currency</th>
            <td>{{ campaign.currency or 'USD (default)' }}</td>
        </tr>
        <tr>
            <th>Remote Preference</th>
            <td>{{ campaign.remote_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Seniority</th>
            <td>{{ campaign.seniority | format_list }}</td>
        </tr>
        <tr>
            <th>Company Size Preference</th>
            <td>{{ campaign.company_size_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Employment Type Preference</th>
            <td>{{ campaign.employment_type_preference | format_list }}</td>
        </tr>
        <tr>
            <th>Email</th>
            <td>{{ campaign.email or '-' }}</td>
        </tr>
    </table>
    
    <h3 style="margin-top: 2rem;">Statistics</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value">{{ campaign.total_run_count or 0 }}</div>
            <div class="stat-label">Total Runs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ campaign.last_run_job_count or 0 }}</div>
            <div class="stat-label">Last Run Jobs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% if campaign.last_run_status == 'success' %}
                    <span style="color: #28a745;">✓</span>
                {% elif campaign.last_run_status == 'error' %}
                    <span style="color: #dc3545;">✗</span>
                {% else %}
                    -
                {% endif %}
            </div>
            <div class="stat-label">Last Run Status</div>
        </div>
        {% if statistics %}
        <div class="stat-item">
            <div class="stat-value">{{ "%.1f"|format(statistics.avg_rank_score or 0) }}</div>
            <div class="stat-label">Avg Ranking Score</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ statistics.total_ranked_jobs or 0 }}</div>
            <div class="stat-label">Total Ranked Jobs</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ "%.1f"|format(statistics.success_rate or 0) }}%</div>
            <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ statistics.jobs_last_30_days or 0 }}</div>
            <div class="stat-label">Jobs (Last 30 Days)</div>
        </div>
        {% endif %}
    </div>
    
    
    <h3 style="margin-top: 2rem;">Timestamps</h3>
    <table style="margin-top: 1rem;">
        <tr>
            <th style="width: 200px;">Created At</th>
            <td>{{ campaign.created_at.strftime('%Y-%m-%d %H:%M:%S') if campaign.created_at else '-' }}</td>
        </tr>
        <tr>
            <th>Updated At</th>
            <td>{{ campaign.updated_at.strftime('%Y-%m-%d %H:%M:%S') if campaign.updated_at else '-' }}</td>
        </tr>
        <tr>
            <th>Last Run At</th>
            <td>{{ campaign.last_run_at.strftime('%Y-%m-%d %H:%M:%S') if campaign.last_run_at else 'Never' }}</td>
        </tr>
    </table>
    
    <div style="margin-top: 2rem;">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to All Campaigns</a>
    </div>
</div>
{% endblock %}
