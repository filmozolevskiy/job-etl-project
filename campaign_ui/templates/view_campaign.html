{% extends "base.html" %}

{% block title %}{{ campaign.campaign_name }} - Campaign Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ campaign.campaign_name }}</h1>
    <a href="{{ url_for('index') }}" class="back-link">← Back to Campaigns</a>
</div>

<div class="stats-grid campaign-details-stats-grid">
    <div class="stat-card-item">
        <div class="stat-label">Status</div>
        <div class="status-with-button">
            <div class="status-badge-container">
                <div class="status-badge 
                    {% if campaign.derived_run_status and campaign.derived_run_status.status == 'error' %}error
                    {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'running' %}processing
                    {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'pending' %}processing
                    {% elif campaign.is_active %}processing
                    {% else %}paused{% endif %}" 
                    id="campaignStatus">
                    <i class="fas 
                        {% if campaign.derived_run_status and campaign.derived_run_status.status == 'error' %}fa-exclamation-circle
                        {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'running' %}fa-cog fa-spin
                        {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'pending' %}fa-spinner fa-spin
                        {% elif campaign.is_active %}fa-play
                        {% else %}fa-pause{% endif %}"></i> 
                    {% if campaign.derived_run_status and campaign.derived_run_status.status == 'error' %}Error
                    {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'running' %}Running
                    {% elif campaign.derived_run_status and campaign.derived_run_status.status == 'pending' %}Pending
                    {% elif campaign.is_active %}Active
                    {% else %}Paused{% endif %}
                </div>
                <form method="POST" action="{{ url_for('trigger_campaign_dag', campaign_id=campaign.campaign_id) }}" style="display: inline;" id="findJobsForm">
                    <button type="submit" class="btn btn-success find-jobs-btn" id="findJobsBtn" data-no-auto-loading>
                        <i class="fas fa-search"></i> Find Jobs
                    </button>
                    {% if is_admin %}
                    <button type="button" class="btn btn-warning find-jobs-btn" id="forceStartBtn" style="display: none; margin-left: 10px;" title="Force start (bypass cooldown)">
                        <i class="fas fa-bolt"></i> Force Start
                    </button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
    <div class="stat-card-item">
        <div class="stat-label">Jobs Processed</div>
        <div class="stat-value">{{ applied_jobs_count or 0 }} / {{ total_jobs or 0 }}</div>
    </div>
    <div class="stat-card-item">
        <div class="stat-label">Last Update</div>
        <div class="stat-value stat-value-small">
            {% if campaign.last_run_at %}
                {{ campaign.last_run_at.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
                Never
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Pass initial campaign data to JavaScript
    window.campaignData = {
        derivedRunStatus: {{ campaign.derived_run_status | tojson if campaign.derived_run_status else 'null' }},
        lastRunAt: {{ campaign.last_run_at.isoformat() | tojson if campaign.last_run_at else 'null' }},
        isActive: {{ campaign.is_active | tojson }}
    };
</script>

<div class="table-header-bar">
    <input type="text" class="search-input" id="jobSearch" placeholder="Search jobs or companies...">
    <div class="header-controls">
        <select id="sortFilter">
            <option value="">Sort</option>
            <option value="date-newest">Date (Newest)</option>
            <option value="date-oldest">Date (Oldest)</option>
            <option value="company-az">Company A-Z</option>
            <option value="fit-score">Fit Score</option>
        </select>
        <div class="multi-select-dropdown" id="statusFilterDropdown">
            <button class="multi-select-button" type="button" id="statusFilterButton" aria-haspopup="true" aria-expanded="false" aria-label="Filter jobs by status">
                <span id="statusFilterText">Status: Loading...</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="multi-select-menu" id="statusFilterMenu" role="listbox" aria-label="Status filter options">
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="all" id="statusAll">
                        <span>All Statuses</span>
                    </label>
                </div>
                <div class="multi-select-divider"></div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="waiting" checked>
                        <span>Waiting</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="approved" checked>
                        <span>Approved</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="applied" checked>
                        <span>Applied</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="interview" checked>
                        <span>Interview</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="offer" checked>
                        <span>Offer</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="rejected">
                        <span>Rejected</span>
                    </label>
                </div>
                <div class="multi-select-item">
                    <label class="multi-select-label">
                        <input type="checkbox" class="status-checkbox" value="archived">
                        <span>Archived</span>
                    </label>
                </div>
            </div>
        </div>
        <button class="refresh-btn" onclick="window.location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<div class="jobs-table-wrapper">
    {% if jobs and jobs|length > 0 %}
    <!-- Desktop Table View -->
    <table class="jobs-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="company">Company Name</th>
                <th class="sortable" data-sort="status">Status</th>
                <th class="sortable" data-sort="date">Posted At</th>
                <th class="sortable" data-sort="title">Job Posting</th>
                <th class="sortable" data-sort="fit">Fit</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr data-job-id="{{ job.jsearch_job_id }}" {% if job.ranked_at %}data-posted-date="{% if job.ranked_at.__class__.__name__ != 'str' %}{{ job.ranked_at.isoformat() }}{% else %}{{ job.ranked_at }}{% endif %}"{% endif %}>
                <td>
                    <div class="table-company-name">
                        {% if job.company_logo and job.company_logo|trim %}
                            <img src="{{ job.company_logo }}" alt="{{ job.company_name or 'Unknown' }}" class="table-company-logo" loading="lazy">
                        {% endif %}
                        <span>{{ job.company_name or 'Unknown' }}</span>
                    </div>
                </td>
                <td>
                    {% set status = job.job_status or 'waiting' %}
                    <span class="table-status-badge {{ status }}">
                        <i class="fas {% if status == 'applied' %}fa-check-circle{% elif status == 'approved' %}fa-thumbs-up{% elif status == 'interview' %}fa-calendar-check{% elif status == 'offer' %}fa-hand-holding-usd{% elif status == 'rejected' %}fa-times-circle{% else %}fa-clock{% endif %}"></i> 
                        {{ status|title }}
                    </span>
                </td>
                <td>
                    {% if job.ranked_at %}
                        {% if job.ranked_at.__class__.__name__ != 'str' %}
                            {% set days_ago = ((now - job.ranked_at).days) if now and job.ranked_at else 0 %}
                            {% if days_ago == 0 %}
                                Today
                            {% elif days_ago == 1 %}
                                1 day ago
                            {% elif days_ago < 7 %}
                                {{ days_ago }} days ago
                            {% elif days_ago < 14 %}
                                1 week ago
                            {% else %}
                                {{ (days_ago / 7)|round(0, 'floor')|int }} weeks ago
                            {% endif %}
                        {% else %}
                            {{ job.ranked_at }}
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <div class="table-job-title">
                        <a href="{{ url_for('view_job_details', job_id=job.jsearch_job_id) }}">
                            {{ job.job_title or 'Unknown Title' }}
                        </a>
                    </div>
                </td>
                <td>
                    <div class="fit-badge-wrapper">
                        {% set score = job.rank_score or 0 %}
                        {% set score_int = score | int %}
                        {% if score_int >= 80 %}
                            <span class="fit-badge perfect-fit">{{ score_int }} Perfect fit</span>
                        {% elif score_int >= 60 %}
                            <span class="fit-badge good-fit">{{ score_int }} Good fit</span>
                        {% else %}
                            <span class="fit-badge moderate-fit">{{ score_int }} Moderate fit</span>
                        {% endif %}
                        <span class="fit-info-icon" 
                              data-company="{{ job.company_name or 'Unknown' }}" 
                              data-job-title="{{ job.job_title or 'Unknown Title' }}" 
                              data-score="{{ score_int }}"
                              data-breakdown='{{ job.rank_explain | tojson if job.rank_explain else "{}" }}'
                              title="View ranking breakdown">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                </td>
                <td>
                    <div class="table-action-buttons">
                        {% if status == 'waiting' %}
                        <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" class="status-update-form">
                            <input type="hidden" name="status" value="approved">
                            <button type="submit" class="btn btn-success btn-small" data-no-auto-loading>Approve</button>
                        </form>
                        <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" class="status-update-form">
                            <input type="hidden" name="status" value="rejected">
                            <button type="submit" class="btn btn-danger btn-small" data-no-auto-loading>Reject</button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Mobile Card View -->
    <div class="cards-container">
        {% for job in jobs %}
        <div class="job-card" data-job-id="{{ job.jsearch_job_id }}">
            <div class="job-card-header">
                <h3 class="job-card-title">
                    <a href="{{ url_for('view_job_details', job_id=job.jsearch_job_id) }}">
                        {{ job.job_title or 'Unknown Title' }}
                    </a>
                </h3>
                <div class="fit-badge-wrapper">
                    {% set score = job.rank_score or 0 %}
                    {% set score_int = score | int %}
                    {% if score_int >= 80 %}
                        <span class="fit-badge perfect-fit">{{ score_int }}</span>
                    {% elif score_int >= 60 %}
                        <span class="fit-badge good-fit">{{ score_int }}</span>
                    {% else %}
                        <span class="fit-badge moderate-fit">{{ score_int }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="job-card-meta">
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Company:</span>
                    <span>
                        {% if job.company_logo and job.company_logo|trim %}
                            <img src="{{ job.company_logo }}" alt="{{ job.company_name or 'Unknown' }}" style="width: 20px; height: 20px; border-radius: 4px; margin-right: 0.5rem; vertical-align: middle;" loading="lazy">
                        {% endif %}
                        {{ job.company_name or 'Unknown' }}
                    </span>
                </div>
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Status:</span>
                    {% set status = job.job_status or 'waiting' %}
                    <span class="table-status-badge {{ status }}">
                        <i class="fas {% if status == 'applied' %}fa-check-circle{% elif status == 'approved' %}fa-thumbs-up{% elif status == 'interview' %}fa-calendar-check{% elif status == 'offer' %}fa-hand-holding-usd{% elif status == 'rejected' %}fa-times-circle{% else %}fa-clock{% endif %}"></i> 
                        {{ status|title }}
                    </span>
                </div>
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Posted:</span>
                    <span>
                        {% if job.ranked_at %}
                            {% if job.ranked_at.__class__.__name__ != 'str' %}
                                {% set days_ago = ((now - job.ranked_at).days) if now and job.ranked_at else 0 %}
                                {% if days_ago == 0 %}
                                    Today
                                {% elif days_ago == 1 %}
                                    1 day ago
                                {% elif days_ago < 7 %}
                                    {{ days_ago }} days ago
                                {% elif days_ago < 14 %}
                                    1 week ago
                                {% else %}
                                    {{ (days_ago / 7)|round(0, 'floor')|int }} weeks ago
                                {% endif %}
                            {% else %}
                                {{ job.ranked_at }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="job-card-actions">
                <a href="{{ url_for('view_job_details', job_id=job.jsearch_job_id) }}" class="btn btn-primary btn-small">
                    <i class="fas fa-eye"></i> View Details
                </a>
                {% if status == 'waiting' %}
                <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" class="status-update-form">
                    <input type="hidden" name="status" value="approved">
                    <button type="submit" class="btn btn-success btn-small" data-no-auto-loading>Approve</button>
                </form>
                <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" class="status-update-form">
                    <input type="hidden" name="status" value="rejected">
                    <button type="submit" class="btn btn-danger btn-small" data-no-auto-loading>Reject</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <h2 class="empty-state-title">No Jobs Found</h2>
            <p class="empty-state-message">This campaign hasn't found any jobs yet. Click "Find Jobs" to start searching for matching positions based on your campaign criteria.</p>
            <form method="POST" action="{{ url_for('trigger_campaign_dag', campaign_id=campaign.campaign_id) }}" style="display: inline;">
                <button type="submit" class="btn btn-primary" id="findJobsBtnEmpty" data-no-auto-loading>
                    <i class="fas fa-search"></i> Find Jobs
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

{% if jobs and jobs|length > 0 %}
<div class="pagination">
    <button class="pagination-btn" id="prevPageBtn" disabled>←</button>
    <span class="pagination-info" id="paginationInfo">1 of {{ ((jobs|length / 20)|round(0, 'ceil')|int) if jobs|length > 20 else 1 }}</span>
    <button class="pagination-btn" id="nextPageBtn" {% if jobs|length <= 20 %}disabled{% endif %}>→</button>
</div>
{% endif %}

<!-- Job Ranking Explanation Modal -->
<div class="modal-overlay" id="rankingModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Job Ranking Breakdown</h3>
            <button class="modal-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <div>
                <strong id="modalCompanyName"></strong> - <span id="modalJobPosition"></span>
            </div>
            <div class="ranking-score">
                Score: <span id="modalScore">0</span>
            </div>
            <div class="ranking-breakdown">
                <h4>Ranking Breakdown</h4>
                <div id="rankingDetails" aria-live="polite"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/rankingModal.js') }}"></script>
<script src="{{ url_for('static', filename='js/campaignDetails.js') }}"></script>
<script>
// Search functionality
document.getElementById('jobSearch')?.addEventListener('input', function(e) {
    // Don't set display here - let updatePagination handle it
    // Update pagination after search
    currentPage = 1;
    updatePagination();
});

// Multi-select status filter functionality
// Valid statuses - must match backend validation in job_status_service.py and database constraint
// Ordered by workflow: waiting -> approved -> applied/interview/offer -> rejected -> archived
const VALID_STATUSES = ['waiting', 'approved', 'applied', 'interview', 'offer', 'rejected', 'archived'];

/**
 * Get array of currently selected status values from checkboxes.
 * @returns {string[]} Array of selected status values, empty array if none selected
 */
function getSelectedStatuses() {
    const checkboxes = document.querySelectorAll('.status-checkbox:not(#statusAll):checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

/**
 * Update the status filter button text to reflect current selection.
 * Shows "All" if all selected, single status name if one selected, count if multiple, or "None" if none selected.
 */
function updateStatusFilterText() {
    const selected = getSelectedStatuses();
    const statusText = document.getElementById('statusFilterText');
    
    if (!statusText) return;
    
    if (selected.length === 0) {
        statusText.textContent = 'Status: None';
    } else if (selected.length === VALID_STATUSES.length) {
        statusText.textContent = 'Status: All';
    } else if (selected.length === 1) {
        statusText.textContent = `Status: ${selected[0].charAt(0).toUpperCase() + selected[0].slice(1)}`;
    } else {
        statusText.textContent = `Status: ${selected.length} selected`;
    }
}

/**
 * Toggle the status filter dropdown menu open/closed state.
 * Closes any other open dropdowns and updates ARIA attributes for accessibility.
 */
function toggleStatusDropdown() {
    const button = document.getElementById('statusFilterButton');
    const menu = document.getElementById('statusFilterMenu');
    
    if (!button || !menu) {
        console.error('Status filter dropdown elements not found');
        return;
    }
    
    const isOpen = menu.classList.contains('open');
    
    // Close all other dropdowns on the page
    document.querySelectorAll('.multi-select-menu.open').forEach(m => {
        if (m !== menu) {
            m.classList.remove('open');
            const otherButton = m.previousElementSibling;
            if (otherButton && otherButton.hasAttribute('aria-expanded')) {
                otherButton.setAttribute('aria-expanded', 'false');
            }
        }
    });
    
    // Toggle current dropdown
    if (isOpen) {
        menu.classList.remove('open');
        button.setAttribute('aria-expanded', 'false');
    } else {
        menu.classList.add('open');
        button.setAttribute('aria-expanded', 'true');
    }
}

/**
 * Handle "All Statuses" checkbox change event.
 * When checked: selects all individual status checkboxes.
 * When unchecked: deselects all statuses (allows empty selection).
 */
function handleStatusAllChange() {
    const statusAll = document.getElementById('statusAll');
    const otherCheckboxes = document.querySelectorAll('.status-checkbox:not(#statusAll)');
    
    if (!statusAll || !otherCheckboxes.length) {
        console.error('Status filter checkboxes not found');
        return;
    }
    
    if (statusAll.checked) {
        // Select all statuses
        otherCheckboxes.forEach(cb => cb.checked = true);
    } else {
        // Deselect all statuses (allows empty selection)
        otherCheckboxes.forEach(cb => cb.checked = false);
    }
    
    // Update "All" checkbox state based on final selection
    const checkedCount = document.querySelectorAll('.status-checkbox:not(#statusAll):checked').length;
    statusAll.checked = (checkedCount === VALID_STATUSES.length);
    statusAll.indeterminate = (checkedCount > 0 && checkedCount < VALID_STATUSES.length);
    
    updateStatusFilterText();
    currentPage = 1;
    updatePagination();
}

/**
 * Handle individual status checkbox change event.
 * Updates "All Statuses" checkbox state (checked/unchecked/indeterminate) based on selection.
 * Allows empty selection (no statuses selected).
 */
function handleStatusCheckboxChange() {
    const statusAll = document.getElementById('statusAll');
    const otherCheckboxes = document.querySelectorAll('.status-checkbox:not(#statusAll)');
    
    if (!statusAll || !otherCheckboxes.length) {
        console.error('Status filter checkboxes not found');
        return;
    }
    
    const checkedCount = document.querySelectorAll('.status-checkbox:not(#statusAll):checked').length;
    
    // Update "All" checkbox state based on selection count
    // Checked: all selected, Indeterminate: some selected, Unchecked: none selected (allowed)
    statusAll.checked = (checkedCount === otherCheckboxes.length);
    statusAll.indeterminate = (checkedCount > 0 && checkedCount < otherCheckboxes.length);
    
    updateStatusFilterText();
    currentPage = 1;
    updatePagination();
}

// Initialize multi-select dropdown
document.addEventListener('DOMContentLoaded', function() {
    const statusButton = document.getElementById('statusFilterButton');
    const statusMenu = document.getElementById('statusFilterMenu');
    const statusAll = document.getElementById('statusAll');
    const statusCheckboxes = document.querySelectorAll('.status-checkbox:not(#statusAll)');
    
    if (statusButton) {
        statusButton.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleStatusDropdown();
        });
        
        // Keyboard accessibility: Enter and Space keys toggle dropdown
        statusButton.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                e.stopPropagation();
                toggleStatusDropdown();
            } else if (e.key === 'Escape') {
                const menu = document.getElementById('statusFilterMenu');
                if (menu && menu.classList.contains('open')) {
                    menu.classList.remove('open');
                    statusButton.setAttribute('aria-expanded', 'false');
                }
            }
        });
    }
    
    if (statusAll) {
        statusAll.addEventListener('change', handleStatusAllChange);
    }
    
    statusCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', handleStatusCheckboxChange);
    });
    
    // Close dropdown when clicking outside
    // Note: Clicks inside the menu (including labels and checkboxes) are automatically excluded by contains() check
    document.addEventListener('click', function(e) {
        if (statusMenu && statusButton && statusMenu.classList.contains('open')) {
            if (!statusButton.contains(e.target) && !statusMenu.contains(e.target)) {
                statusMenu.classList.remove('open');
                statusButton.setAttribute('aria-expanded', 'false');
            }
        }
    });
    
    // Close dropdown on Escape key press (global handler)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && statusMenu && statusMenu.classList.contains('open')) {
            statusMenu.classList.remove('open');
            if (statusButton) {
                statusButton.setAttribute('aria-expanded', 'false');
                statusButton.focus(); // Return focus to button for accessibility
            }
        }
    });
    
    // Initialize button text and ARIA state
    if (statusButton) {
        statusButton.setAttribute('aria-expanded', 'false');
    }
    
    // Initialize "All Statuses" checkbox state based on current selection
    const checkedCount = document.querySelectorAll('.status-checkbox:not(#statusAll):checked').length;
    if (statusAll) {
        statusAll.checked = (checkedCount === VALID_STATUSES.length);
        statusAll.indeterminate = (checkedCount > 0 && checkedCount < VALID_STATUSES.length);
    }
    
    // Update filter text on page load (must happen after checkbox initialization)
    updateStatusFilterText();
    
    // Verify all status checkboxes exist and match VALID_STATUSES
    if (statusCheckboxes.length !== VALID_STATUSES.length) {
        console.warn(`Status checkbox count (${statusCheckboxes.length}) does not match VALID_STATUSES (${VALID_STATUSES.length})`);
    }
});

// Sort functionality
document.getElementById('sortFilter')?.addEventListener('change', function(e) {
    const sortValue = e.target.value;
    const tbody = document.querySelector('.jobs-table tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        switch(sortValue) {
            case 'date-newest':
                // Sort by date (newest first) - parse from data attribute
                const dateA = a.getAttribute('data-posted-date');
                const dateB = b.getAttribute('data-posted-date');
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1; // Missing dates go to end
                if (!dateB) return -1;
                const timeA = new Date(dateA).getTime();
                const timeB = new Date(dateB).getTime();
                return timeB - timeA; // Newest first (descending)
            case 'date-oldest':
                // Sort by date (oldest first) - parse from data attribute
                const dateAOld = a.getAttribute('data-posted-date');
                const dateBOld = b.getAttribute('data-posted-date');
                if (!dateAOld && !dateBOld) return 0;
                if (!dateAOld) return 1; // Missing dates go to end
                if (!dateBOld) return -1;
                const timeAOld = new Date(dateAOld).getTime();
                const timeBOld = new Date(dateBOld).getTime();
                return timeAOld - timeBOld; // Oldest first (ascending)
            case 'company-az':
                const companyA = a.querySelector('.table-company-name span')?.textContent || a.querySelector('.table-company-name')?.textContent || '';
                const companyB = b.querySelector('.table-company-name span')?.textContent || b.querySelector('.table-company-name')?.textContent || '';
                return companyA.localeCompare(companyB);
            case 'fit-score':
                const scoreA = parseInt(a.querySelector('.fit-badge')?.textContent || '0');
                const scoreB = parseInt(b.querySelector('.fit-badge')?.textContent || '0');
                return scoreB - scoreA; // Descending order
            default:
                return 0;
        }
    });
    
    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update pagination after sort
    currentPage = 1;
    setTimeout(updatePagination, 10);
});

// Pagination functionality
let currentPage = 1;
const jobsPerPage = 20;

function getVisibleRows() {
    const allRows = document.querySelectorAll('.jobs-table tbody tr');
    return Array.from(allRows).filter(row => {
        // Check if row is hidden by search/filter (not by pagination)
        // We need to check if it was hidden by inline style from search/filter
        // vs hidden by pagination. We'll use a data attribute to track this.
        const isFilteredOut = row.hasAttribute('data-filtered-out') && row.getAttribute('data-filtered-out') === 'true';
        if (isFilteredOut) {
            return false;
        }
        // Check computed style - if it's none, it might be from pagination or filter
        // We'll check the inline style to see if it was explicitly set to none by filter
        const inlineDisplay = row.style.display;
        // If inline display is explicitly set to 'none', it's filtered out
        if (inlineDisplay === 'none') {
            // Check if it's from filter or pagination
            // If row doesn't have data-pagination-hidden, assume it's from filter
            return row.hasAttribute('data-pagination-hidden');
        }
        return true;
    });
}

function updatePagination() {
    const allRows = document.querySelectorAll('.jobs-table tbody tr');
    const searchTerm = (document.getElementById('jobSearch')?.value || '').toLowerCase();
    const selectedStatuses = getSelectedStatuses();
    
    // Get rows that match current filters
    const matchingRows = Array.from(allRows).filter(row => {
        // Check search filter
        if (searchTerm) {
            const text = row.textContent.toLowerCase();
            if (!text.includes(searchTerm)) {
                return false;
            }
        }
        
        // Check status filter (multiple statuses)
        const statusBadge = row.querySelector('.table-status-badge');
        const currentStatus = statusBadge ? statusBadge.className.split(' ').find(c => c !== 'table-status-badge') : 'waiting';
        if (!selectedStatuses.includes(currentStatus)) {
            return false;
        }
        
        return true;
    });
    
    const totalVisibleJobs = matchingRows.length;
    const totalPages = Math.max(1, Math.ceil(totalVisibleJobs / jobsPerPage));
    
    // Ensure currentPage is within valid range
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }
    if (currentPage < 1) {
        currentPage = 1;
    }
    
    // Update pagination info
    const paginationInfo = document.getElementById('paginationInfo');
    if (paginationInfo) {
        paginationInfo.textContent = `${currentPage} of ${totalPages}`;
    }
    
    // Update button states
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (prevBtn) {
        prevBtn.disabled = (currentPage === 1 || totalVisibleJobs === 0);
    }
    if (nextBtn) {
        nextBtn.disabled = (currentPage >= totalPages || totalVisibleJobs === 0);
    }
    
    // Show/hide rows based on current page (only for matching rows)
    const startIndex = (currentPage - 1) * jobsPerPage;
    const endIndex = startIndex + jobsPerPage;
    
    let visibleIndex = 0;
    allRows.forEach((row) => {
        // Check if row matches filters
        let matches = true;
        
        if (searchTerm) {
            const text = row.textContent.toLowerCase();
            if (!text.includes(searchTerm)) {
                matches = false;
            }
        }
        
        if (matches) {
            const selectedStatuses = getSelectedStatuses();
            const statusBadge = row.querySelector('.table-status-badge');
            const currentStatus = statusBadge ? statusBadge.className.split(' ').find(c => c !== 'table-status-badge') : 'waiting';
            if (!selectedStatuses.includes(currentStatus)) {
                matches = false;
            }
        }
        
        if (matches) {
            // Row matches filters - show/hide based on pagination
            if (visibleIndex >= startIndex && visibleIndex < endIndex) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
            visibleIndex++;
        } else {
            // Row doesn't match filters - keep it hidden
            row.style.display = 'none';
        }
    });
    
    // Also filter mobile cards
    const allCards = document.querySelectorAll('.job-card');
    allCards.forEach((card) => {
        // Check if card matches filters
        let matches = true;
        
        if (searchTerm) {
            const text = card.textContent.toLowerCase();
            if (!text.includes(searchTerm)) {
                matches = false;
            }
        }
        
        if (matches) {
            const selectedStatuses = getSelectedStatuses();
            const statusBadge = card.querySelector('.table-status-badge');
            const currentStatus = statusBadge ? statusBadge.className.split(' ').find(c => c !== 'table-status-badge') : 'waiting';
            if (!selectedStatuses.includes(currentStatus)) {
                matches = false;
            }
        }
        
        // Show/hide card based on filter match
        if (matches) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

function goToPage(page) {
    // Get matching rows count
    const allRows = document.querySelectorAll('.jobs-table tbody tr');
    const searchTerm = (document.getElementById('jobSearch')?.value || '').toLowerCase();
    const selectedStatuses = getSelectedStatuses();
    
    const matchingRows = Array.from(allRows).filter(row => {
        if (searchTerm) {
            const text = row.textContent.toLowerCase();
            if (!text.includes(searchTerm)) return false;
        }
        const statusBadge = row.querySelector('.table-status-badge');
        const currentStatus = statusBadge ? statusBadge.className.split(' ').find(c => c !== 'table-status-badge') : 'waiting';
        if (!selectedStatuses.includes(currentStatus)) return false;
        return true;
    });
    
    const totalPages = Math.max(1, Math.ceil(matchingRows.length / jobsPerPage));
    
    if (page < 1 || page > totalPages) {
        return;
    }
    
    currentPage = page;
    updatePagination();
}

// Initialize fit info icons and pagination
document.addEventListener('DOMContentLoaded', function() {
    // Initialize pagination
    updatePagination();
    
    // Pagination button handlers
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!this.disabled && currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!this.disabled) {
                goToPage(currentPage + 1);
            }
        });
    }
    
    
    // ========================================
    // AJAX Status Update Functionality
    // ========================================
    
    // Status icon mapping
    const STATUS_ICONS = {
        'waiting': 'fa-clock',
        'applied': 'fa-check-circle',
        'approved': 'fa-thumbs-up',
        'interview': 'fa-calendar-check',
        'offer': 'fa-hand-holding-usd',
        'rejected': 'fa-times-circle',
        'archived': 'fa-archive'
    };
    
    /**
     * Update status badge in table row
     * @param {string} jobId - Job ID
     * @param {string} newStatus - New status value
     */
    function updateStatusBadge(jobId, newStatus) {
        // Find the row by job ID
        const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
        if (!row) return;
        
        const statusBadge = row.querySelector('.table-status-badge');
        if (!statusBadge) return;
        
        // Update classes
        statusBadge.className = `table-status-badge ${newStatus}`;
        
        // Update icon
        const icon = statusBadge.querySelector('i');
        if (icon) {
            icon.className = `fas ${STATUS_ICONS[newStatus] || 'fa-clock'}`;
        }
        
        // Update text - find text after icon and replace it
        const statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
        const textNodes = Array.from(statusBadge.childNodes).filter(node => 
            node.nodeType === Node.TEXT_NODE
        );
        
        // Remove existing text nodes
        textNodes.forEach(node => node.remove());
        
        // Add new text node
        const textNode = document.createTextNode(' ' + statusText);
        statusBadge.appendChild(textNode);
        
        // Update action buttons
        const actionCell = row.querySelector('.table-action-buttons');
        if (actionCell) {
            if (newStatus === 'waiting') {
                // Show approve/reject buttons
                actionCell.innerHTML = `
                    <form method="POST" action="/jobs/${jobId}/status" style="display: inline;" class="status-update-form">
                        <input type="hidden" name="status" value="approved">
                        <button type="submit" class="btn btn-success btn-small" data-no-auto-loading>Approve</button>
                    </form>
                    <form method="POST" action="/jobs/${jobId}/status" style="display: inline;" class="status-update-form">
                        <input type="hidden" name="status" value="rejected">
                        <button type="submit" class="btn btn-danger btn-small" data-no-auto-loading>Reject</button>
                    </form>
                `;
                // Re-attach event listeners to new buttons
                attachStatusFormHandlers(actionCell);
            } else {
                // Hide buttons for non-waiting statuses
                actionCell.innerHTML = '';
            }
        }
    }
    
    /**
     * Update mobile card view status badge and buttons
     * @param {string} jobId - Job ID
     * @param {string} newStatus - New status value
     */
    function updateMobileCardStatus(jobId, newStatus) {
        const card = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
        if (!card) return;
        
        const statusBadge = card.querySelector('.table-status-badge');
        if (statusBadge) {
            // Update classes
            statusBadge.className = `table-status-badge ${newStatus}`;
            
            // Update icon
            const icon = statusBadge.querySelector('i');
            if (icon) {
                icon.className = `fas ${STATUS_ICONS[newStatus] || 'fa-clock'}`;
            }
            
            // Update text
            const statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            const textNodes = Array.from(statusBadge.childNodes).filter(node => 
                node.nodeType === Node.TEXT_NODE
            );
            
            // Remove existing text nodes
            textNodes.forEach(node => node.remove());
            
            // Add new text node
            const textNode = document.createTextNode(' ' + statusText);
            statusBadge.appendChild(textNode);
        }
        
        // Update action buttons in mobile view
        const actions = card.querySelector('.job-card-actions');
        if (actions) {
            const viewBtn = actions.querySelector('a');
            
            if (newStatus === 'waiting') {
                // Show approve/reject buttons
                actions.innerHTML = '';
                if (viewBtn) {
                    actions.appendChild(viewBtn);
                }
                actions.innerHTML += `
                    <form method="POST" action="/jobs/${jobId}/status" style="display: inline;" class="status-update-form">
                        <input type="hidden" name="status" value="approved">
                        <button type="submit" class="btn btn-success btn-small" data-no-auto-loading>Approve</button>
                    </form>
                    <form method="POST" action="/jobs/${jobId}/status" style="display: inline;" class="status-update-form">
                        <input type="hidden" name="status" value="rejected">
                        <button type="submit" class="btn btn-danger btn-small" data-no-auto-loading>Reject</button>
                    </form>
                `;
                attachStatusFormHandlers(actions);
            } else {
                // Keep only view details button
                actions.innerHTML = '';
                if (viewBtn) {
                    actions.appendChild(viewBtn);
                }
            }
        }
    }
    
    /**
     * Handle form submission via AJAX
     * @param {Event} event - Form submit event
     */
    function handleStatusUpdate(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const jobId = form.action.split('/jobs/')[1].split('/status')[0];
        const status = formData.get('status');
        const button = form.querySelector('button[type="submit"]');
        const originalText = button ? button.innerHTML : '';
        const row = form.closest('tr') || form.closest('.job-card');
        
        // Optimistic UI update - update immediately
        if (status === 'approved' || status === 'rejected') {
            // Update button immediately
            if (button) {
                button.disabled = true;
                if (status === 'approved') {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
                } else {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
                }
            }
            
            // Hide the other button (approve/reject pair)
            const actionButtons = form.closest('.table-action-buttons') || form.closest('.job-card-actions');
            if (actionButtons) {
                const otherForm = actionButtons.querySelector(`form:not([action*="${status}"])`);
                if (otherForm) {
                    otherForm.style.display = 'none';
                }
            }
        } else {
            // Disable button during request for other statuses
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            }
        }
        
        // Make AJAX request
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ status: status }),
            credentials: 'same-origin'
        })
        .then(async response => {
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');
            
            if (!response.ok) {
                // Try to parse JSON error response
                if (isJson) {
                    try {
                        const data = await response.json();
                        throw new Error(data.error || 'An error occurred while updating the status');
                    } catch (parseError) {
                        // If JSON parsing fails, throw a generic error
                        throw new Error('An error occurred while updating the status. Please try again.');
                    }
                } else {
                    // Non-JSON error response (e.g., HTML error page, redirect)
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('Your session has expired. Please refresh the page and try again.');
                    } else if (response.status >= 500) {
                        throw new Error('A server error occurred. Please try again later.');
                    } else {
                        throw new Error('An error occurred while updating the status. Please try again.');
                    }
                }
            }
            
            // Parse successful JSON response
            if (isJson) {
                try {
                    return await response.json();
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    throw new Error('An error occurred while processing the response. Please try again.');
                }
            } else {
                // Non-JSON response (shouldn't happen for successful requests)
                throw new Error('Unexpected response format. Please try again.');
            }
        })
        .then(data => {
            if (data.success) {
                // Update UI optimistically
                updateStatusBadge(jobId, status);
                updateMobileCardStatus(jobId, status);
                
                // Update button to show success state
                if (button) {
                    if (status === 'approved') {
                        button.innerHTML = '<i class="fas fa-check"></i> Approved';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-success', 'btn-approved');
                        button.disabled = true;
                    } else if (status === 'rejected') {
                        button.innerHTML = '<i class="fas fa-times"></i> Rejected';
                        button.classList.remove('btn-danger');
                        button.classList.add('btn-danger', 'btn-rejected');
                        button.disabled = true;
                    }
                }
                
                // Show success notification with specific message
                const message = status === 'approved' 
                    ? 'Job approved successfully!' 
                    : status === 'rejected'
                    ? 'Job rejected successfully!'
                    : data.message || 'Status updated successfully!';
                
                if (typeof Utils !== 'undefined' && Utils.showNotification) {
                    Utils.showNotification(message, 'success');
                } else {
                    // Fallback notification
                    console.log(message);
                }
            } else {
                throw new Error(data.error || 'Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error updating status:', error);
            
            // Show user-friendly error message
            const userMessage = error.message || 'An unexpected error occurred. Please try again.';
            if (typeof Utils !== 'undefined' && Utils.showNotification) {
                Utils.showNotification(userMessage, 'error');
            } else {
                alert(userMessage);
            }
            
            // Re-enable button on error
            if (button) {
                button.disabled = false;
                button.textContent = originalText;
            }
        });
    }
    
    /**
     * Attach handlers to all status update forms
     * @param {Element} container - Container element to search within (default: document)
     */
    function attachStatusFormHandlers(container = document) {
        const forms = container.querySelectorAll('.status-update-form');
        forms.forEach(form => {
            // Check if handler is already attached using a data attribute
            if (!form.dataset.handlerAttached) {
                form.addEventListener('submit', handleStatusUpdate);
                form.dataset.handlerAttached = 'true';
            }
        });
    }
    
    // Initialize status form handlers on page load
    attachStatusFormHandlers();
    
    // Initialize ranking modal (backup initialization in case campaignDetails.js DOMContentLoaded handler doesn't run)
    if (typeof initializeRankingModal === 'function') {
        initializeRankingModal();
    }
    
});
</script>
{% endblock %}
