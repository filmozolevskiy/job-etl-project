{% extends "base.html" %}

{% block title %}Jobs{% if campaign_name %} - {{ campaign_name }}{% endif %} - Campaign Management{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }
    
    .page-header h1 {
        margin: 0;
    }
    
    .table-header-bar {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 200px;
    }
    
    .header-controls {
        display: flex;
        gap: var(--spacing-sm);
        flex-wrap: wrap;
    }
    
    .status-dropdown {
        padding: 0.5rem;
        border: 2px solid var(--color-border-light);
        border-radius: var(--radius-md);
        font-size: var(--font-size-base);
        cursor: pointer;
        background-color: var(--color-surface);
    }
    
    .status-dropdown:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }
    
    .fit-badge-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
    }
    
    .fit-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
        font-weight: 600;
    }
    
    .fit-badge.perfect-fit {
        background-color: var(--color-success-bg);
        color: var(--color-success-text);
    }
    
    .fit-badge.good-fit {
        background-color: var(--color-info-bg);
        color: var(--color-info-text);
    }
    
    .fit-badge.moderate-fit {
        background-color: var(--color-warning-bg);
        color: var(--color-warning-text);
    }
    
    .note-icon {
        cursor: pointer;
        color: var(--color-primary);
        margin-left: var(--spacing-sm);
        font-size: var(--font-size-base);
    }
    
    .note-icon:hover {
        color: var(--color-primary-dark);
    }
    
    .note-preview {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--color-text-muted);
        font-size: var(--font-size-sm);
    }
    
    .table-job-title a {
        color: var(--color-text-primary);
        text-decoration: none;
        transition: color var(--transition-fast);
    }
    
    .table-job-title a:hover {
        color: var(--color-primary);
        text-decoration: underline;
    }
    
    .job-posting-link {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        color: var(--color-primary);
        text-decoration: none;
        margin-left: var(--spacing-xs);
    }
    
    .job-posting-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Jobs{% if campaign_name %} - {{ campaign_name }}{% endif %}</h1>
    </div>
    <div>
        {% if campaign_id %}
            <a href="{{ url_for('view_campaign', campaign_id=campaign_id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Campaign
            </a>
        {% else %}
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Campaigns
            </a>
        {% endif %}
    </div>
</div>

<div class="table-header-bar">
    <input type="text" class="search-input" id="jobSearch" placeholder="Search jobs or companies...">
    <div class="header-controls">
        <select id="statusFilter">
            <option value="all">All Status</option>
            <option value="waiting">Waiting</option>
            <option value="applied">Applied</option>
            <option value="interview">Interview</option>
            <option value="offer">Offer</option>
            <option value="rejected">Rejected</option>
            <option value="archived">Archived</option>
        </select>
        <button class="refresh-btn" onclick="window.location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<div class="jobs-table-wrapper">
    {% if jobs %}
    <!-- Desktop Table View -->
    <table class="jobs-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="company">Company Name</th>
                <th class="sortable" data-sort="status">Status</th>
                <th class="sortable" data-sort="date">Updated At</th>
                <th class="sortable" data-sort="title">Job Posting</th>
                <th class="sortable" data-sort="fit">Fit</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td>
                    <div class="table-company-name">{{ job.company_name or 'Unknown' }}</div>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" onchange="this.submit()">
                        <select name="status" class="status-dropdown">
                            <option value="waiting" {% if (job.job_status or 'waiting') == 'waiting' %}selected{% endif %}>Waiting</option>
                            <option value="applied" {% if job.job_status == 'applied' %}selected{% endif %}>Applied</option>
                            <option value="interview" {% if job.job_status == 'interview' %}selected{% endif %}>Interview</option>
                            <option value="offer" {% if job.job_status == 'offer' %}selected{% endif %}>Offer</option>
                            <option value="rejected" {% if job.job_status == 'rejected' %}selected{% endif %}>Rejected</option>
                            <option value="archived" {% if job.job_status == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </form>
                </td>
                <td>
                    {% if job.ranked_at %}
                        {{ job.ranked_at.strftime('%Y-%m-%d %H:%M') if job.ranked_at.__class__.__name__ != 'str' else job.ranked_at }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <div class="table-job-title">
                        {{ job.job_title }}
                        {% if job.apply_options %}
                            {% set apply_options_parsed = job.apply_options | from_json %}
                            {% if apply_options_parsed %}
                                {% if apply_options_parsed is mapping %}
                                    {% set apply_link = apply_options_parsed.get('apply_link') %}
                                {% elif apply_options_parsed is iterable and apply_options_parsed[0] is mapping %}
                                    {% set apply_link = apply_options_parsed[0].get('apply_link') %}
                                {% endif %}
                                {% if apply_link %}
                                    <a href="{{ apply_link }}" target="_blank" class="job-posting-link" title="Open job posting">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div class="fit-badge-wrapper">
                        {% set score = job.rank_score or 0 %}
                        {% set score_int = score | int %}
                        {% if score_int >= 80 %}
                            <span class="fit-badge perfect-fit">{{ score_int }} Perfect fit</span>
                        {% elif score_int >= 60 %}
                            <span class="fit-badge good-fit">{{ score_int }} Good fit</span>
                        {% else %}
                            <span class="fit-badge moderate-fit">{{ score_int }} Moderate fit</span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-xs);">
                        {% if job.note_text %}
                            <div class="note-preview" title="{{ job.note_text|e }}">
                                {{ job.note_text[:30] }}{% if job.note_text|length > 30 %}...{% endif %}
                            </div>
                        {% endif %}
                        <button class="note-icon" onclick="openNoteModal('{{ job.jsearch_job_id }}', '{{ job.job_title|e }}', {% if job.note_text %}'{{ job.note_text|e }}'{% else %}''{% endif %})" title="{% if job.note_text %}Edit Note{% else %}Add Note{% endif %}">
                            <i class="fas {% if job.note_text %}fa-edit{% else %}fa-plus{% endif %}"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Mobile Card View -->
    <div class="cards-container">
        {% for job in jobs %}
        <div class="job-card">
            <div class="job-card-header">
                <h3 class="job-card-title">{{ job.job_title }}</h3>
                <div class="fit-badge-wrapper">
                    {% set score = job.rank_score or 0 %}
                    {% set score_int = score | int %}
                    {% if score_int >= 80 %}
                        <span class="fit-badge perfect-fit">{{ score_int }}</span>
                    {% elif score_int >= 60 %}
                        <span class="fit-badge good-fit">{{ score_int }}</span>
                    {% else %}
                        <span class="fit-badge moderate-fit">{{ score_int }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="job-card-meta">
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Company:</span>
                    <span>{{ job.company_name or 'Unknown' }}</span>
                </div>
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Status:</span>
                    <form method="POST" action="{{ url_for('update_job_status', job_id=job.jsearch_job_id) }}" style="display: inline;" onchange="this.submit()">
                        <select name="status" class="status-dropdown" style="width: auto; min-width: 120px;">
                            <option value="waiting" {% if (job.job_status or 'waiting') == 'waiting' %}selected{% endif %}>Waiting</option>
                            <option value="applied" {% if job.job_status == 'applied' %}selected{% endif %}>Applied</option>
                            <option value="interview" {% if job.job_status == 'interview' %}selected{% endif %}>Interview</option>
                            <option value="offer" {% if job.job_status == 'offer' %}selected{% endif %}>Offer</option>
                            <option value="rejected" {% if job.job_status == 'rejected' %}selected{% endif %}>Rejected</option>
                            <option value="archived" {% if job.job_status == 'archived' %}selected{% endif %}>Archived</option>
                        </select>
                    </form>
                </div>
                <div class="job-card-meta-item">
                    <span class="job-card-meta-label">Updated:</span>
                    <span>
                        {% if job.ranked_at %}
                            {{ job.ranked_at.strftime('%Y-%m-%d %H:%M') if job.ranked_at.__class__.__name__ != 'str' else job.ranked_at }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>
                {% if job.apply_options %}
                    {% set apply_options_parsed = job.apply_options | from_json %}
                    {% if apply_options_parsed %}
                        {% if apply_options_parsed is mapping %}
                            {% set apply_link = apply_options_parsed.get('apply_link') %}
                        {% elif apply_options_parsed is iterable and apply_options_parsed[0] is mapping %}
                            {% set apply_link = apply_options_parsed[0].get('apply_link') %}
                        {% endif %}
                        {% if apply_link %}
                        <div class="job-card-meta-item">
                            <span class="job-card-meta-label">Apply:</span>
                            <a href="{{ apply_link }}" target="_blank" class="job-posting-link">
                                <i class="fas fa-external-link-alt"></i> View Posting
                            </a>
                        </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
            {% if job.note_text %}
            <div class="job-card-meta-item" style="margin-top: var(--spacing-sm);">
                <span class="job-card-meta-label">Note:</span>
                <span class="note-preview">{{ job.note_text[:50] }}{% if job.note_text|length > 50 %}...{% endif %}</span>
            </div>
            {% endif %}
            <div class="job-card-actions">
                <a href="{{ url_for('view_job_details', job_id=job.jsearch_job_id) }}" class="btn btn-primary btn-small">
                    <i class="fas fa-eye"></i> View Details
                </a>
                <button class="btn btn-secondary btn-small note-icon" onclick="openNoteModal('{{ job.jsearch_job_id }}', '{{ job.job_title|e }}', {% if job.note_text %}'{{ job.note_text|e }}'{% else %}''{% endif %})" title="{% if job.note_text %}Edit Note{% else %}Add Note{% endif %}">
                    <i class="fas {% if job.note_text %}fa-edit{% else %}fa-plus{% endif %}"></i> {% if job.note_text %}Edit Note{% else %}Add Note{% endif %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <h2 class="empty-state-title">No Jobs Found</h2>
            <p class="empty-state-message">
                {% if campaign_id %}
                    No jobs have been found for this campaign yet. Try running "Find Jobs" to search for matching positions.
                {% else %}
                    No jobs match your current filters. Try adjusting your search criteria or filters.
                {% endif %}
            </p>
            {% if campaign_id %}
            <a href="{{ url_for('view_campaign', campaign_id=campaign_id) }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Back to Campaign
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Add Note for <span id="modalJobTitle"></span></h3>
            <button class="modal-close" onclick="closeNoteModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <form id="noteForm" method="POST" action="">
                <input type="hidden" name="job_id" id="modalJobId">
                <div class="form-group">
                    <label for="note_text">Note:</label>
                    <textarea id="note_text" name="note_text" rows="5"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Note</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openNoteModal(jobId, jobTitle, existingNote) {
    document.getElementById('modalJobId').value = jobId;
    document.getElementById('modalJobTitle').textContent = jobTitle;
    document.getElementById('note_text').value = (existingNote || '').replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&lt;/g, '<').replace(/&gt;/g, '>');
    document.getElementById('noteForm').action = '/jobs/' + encodeURIComponent(jobId) + '/note';
    document.getElementById('noteModal').classList.add('active');
}

function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
}

// Close modal when clicking outside
document.getElementById('noteModal')?.addEventListener('click', function(event) {
    if (event.target === this) {
        closeNoteModal();
    }
});

// Search functionality
document.getElementById('jobSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.jobs-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Status filter functionality
document.getElementById('statusFilter')?.addEventListener('change', function(e) {
    const filterValue = e.target.value;
    const rows = document.querySelectorAll('.jobs-table tbody tr');
    
    rows.forEach(row => {
        if (filterValue === 'all') {
            row.style.display = '';
        } else {
            const statusSelect = row.querySelector('.status-dropdown');
            const currentStatus = statusSelect ? statusSelect.value : '';
            row.style.display = currentStatus === filterValue ? '' : 'none';
        }
    });
});
</script>
{% endblock %}
