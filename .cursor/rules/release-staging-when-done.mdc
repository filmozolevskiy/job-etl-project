---
description: Release staging slot in registry when work using that slot is finished
alwaysApply: true
---

# Release Staging Resources When Finished

When work that used a staging slot is **finished** (PR merged to main, or task abandoned), you **must** release that slot so others can use it.

Staging slot usage is stored in the **database** (`marts.staging_slots`), not in a file. Use the **Staging API** or direct DB updates.

## When to release

- **After merge**: When the PR for the task is merged to main (Deploy phase: "CI Pass: Release slot").
- **When wrapping up**: When closing out a task that had claimed a slot, even if the PR was merged earlier and the slot wasn’t released yet.
- **When QA fails and task is closed**: If the issue is closed without merging, release the slot when you’re done with that branch.

## What to do

1. **Release via Staging API** (preferred when the app is available):
   - **POST** `/api/staging/slots/<slot_id>/release` (admin JWT required).
   - Example: slot 2 → `POST /api/staging/slots/2/release`.
   - The Staging Dashboard (e.g. https://justapply.net/staging) can also release slots via the UI.

2. **Release via database** (when API is not available, e.g. from a script or migration):
   - Update the DB that backs the Staging Dashboard (e.g. production’s `marts` schema):
   - `UPDATE marts.staging_slots SET status = 'Available', owner = NULL, branch = NULL, issue_id = NULL, deployed_at = NULL, purpose = NULL, health_status = 'Unknown', updated_at = CURRENT_TIMESTAMP WHERE slot_id = <N>;`

3. **Commit** any script or config changes that perform release; the registry itself lives in the DB, so no file commit is required for the release.

## Optional cleanup

- Stop services on the slot if desired: `docker compose -p staging-N down` (on the staging droplet).
- Do **not** remove the slot’s checkout folder unless the project explicitly requests it.

## Tie-in with Phase Checklist

In the Deploy phase, "Release slot" means: release via Staging API or DB as above **and** remove worktree / delete branch. Releasing the slot is required even when merging via a separate chore PR; use the API or a one-off DB update so the registry stays accurate.
