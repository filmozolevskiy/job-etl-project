# Staging-specific Docker Compose overrides
#
# This file provides environment-specific overrides for staging deployments.
# It disables the local PostgreSQL container (uses managed DB) and configures
# ports dynamically based on the STAGING_SLOT variable.
#
# Usage:
#   STAGING_SLOT=1 docker compose -f docker-compose.yml -f docker-compose.staging.yml -p staging-1 up -d
#
# Port Mapping (based on STAGING_SLOT):
#   - Campaign UI: 5000 + STAGING_SLOT (e.g., slot 1 = 5001)
#   - Airflow UI:  8080 + STAGING_SLOT (e.g., slot 1 = 8081)
#   - Frontend:    5173 + STAGING_SLOT (e.g., slot 1 = 5174)

services:
  # Disable local PostgreSQL - staging uses DigitalOcean Managed PostgreSQL
  # Note: We can't use profiles because dependent services still require it
  # Instead, we override the postgres service to be a lightweight noop
  postgres:
    image: alpine:latest
    # Override volumes to avoid mounting init scripts
    volumes: []
    command: ["sh", "-c", "echo 'PostgreSQL disabled - using managed database' && sleep infinity"]
    healthcheck:
      test: ["CMD", "true"]
      interval: 5s
      timeout: 3s
      retries: 1

  airflow-webserver:
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_started
    environment:
      # Override database connection for managed PostgreSQL
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=require
      # Override internal Postgres connection for services
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Staging slot identifier for version tracking
      STAGING_SLOT: ${STAGING_SLOT:-1}
      DEPLOYED_SHA: ${DEPLOYED_SHA:-unknown}
      DEPLOYED_BRANCH: ${DEPLOYED_BRANCH:-unknown}
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8081}:8080"
    labels:
      - "staging.slot=${STAGING_SLOT:-1}"
      - "staging.service=airflow-webserver"

  airflow-scheduler:
    depends_on:
      airflow-init:
        condition: service_started
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=require
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      STAGING_SLOT: ${STAGING_SLOT:-1}
      DEPLOYED_SHA: ${DEPLOYED_SHA:-unknown}
      DEPLOYED_BRANCH: ${DEPLOYED_BRANCH:-unknown}
    labels:
      - "staging.slot=${STAGING_SLOT:-1}"
      - "staging.service=airflow-scheduler"

  airflow-init:
    depends_on: []
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=require
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    labels:
      - "staging.slot=${STAGING_SLOT:-1}"
      - "staging.service=airflow-init"

  campaign-ui:
    depends_on: []
    # Use image as built (no host mounts) so /app/services exists and CD health check passes
    volumes: []
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_SSL_MODE: require
      FLASK_ENV: production
      FLASK_DEBUG: 0
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      # Version tracking
      STAGING_SLOT: ${STAGING_SLOT:-1}
      DEPLOYED_SHA: ${DEPLOYED_SHA:-unknown}
      DEPLOYED_BRANCH: ${DEPLOYED_BRANCH:-unknown}
    ports:
      - "${CAMPAIGN_UI_PORT:-5001}:5000"
    labels:
      - "staging.slot=${STAGING_SLOT:-1}"
      - "staging.service=campaign-ui"

  frontend:
    ports:
      - "${FRONTEND_PORT:-5174}:80"
    labels:
      - "staging.slot=${STAGING_SLOT:-1}"
      - "staging.service=frontend"

networks:
  job_search_network:
    name: staging_${STAGING_SLOT:-1}_network

volumes:
  postgres_data:
    name: staging_${STAGING_SLOT:-1}_postgres_data
