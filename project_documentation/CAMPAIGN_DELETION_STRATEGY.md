# Campaign Deletion Strategy

## Overview

This document describes the comprehensive strategy for preventing new campaigns from inheriting jobs from previous campaigns and ensuring complete data cleanup when campaigns are deleted.

## Problem Statement

When campaigns are deleted and recreated, there was a risk that:
1. Campaign IDs could be reused, causing new campaigns to show old jobs
2. Orphaned data (rankings, jobs, notes, status) could remain in the database
3. Incomplete job data (rankings without fact_jobs) could be displayed

## Solution Components

### 1. Campaign ID Uniqueness

**Implementation:**
- `campaign_id` is `SERIAL PRIMARY KEY` in `marts.job_campaigns`
- Sequence-based generation: `marts.job_campaigns_campaign_id_seq`
- PRIMARY KEY constraint prevents duplicate IDs
- IDs are never reused, even after deletions

**Migration:** `docker/init/99_fix_campaign_id_uniqueness.sql`

### 2. Foreign Key Constraints with CASCADE DELETE

**Tables with CASCADE DELETE:**
- `marts.dim_ranking` → `marts.job_campaigns(campaign_id)`
- `marts.etl_run_metrics` → `marts.job_campaigns(campaign_id)`
- `marts.fact_jobs` → `marts.job_campaigns(campaign_id)` (if table exists)
- `marts.user_job_status` → `marts.job_campaigns(campaign_id)` (added in migration 100)
- `marts.job_notes` → `marts.job_campaigns(campaign_id)` (added in migration 100)

**Migration:** 
- `docker/init/02_create_tables.sql` (initial FK constraints)
- `docker/init/99_fix_campaign_id_uniqueness.sql` (ensures FK constraints exist)
- `docker/init/100_add_campaign_id_to_user_tables.sql` (adds campaign_id to user tables)

### 3. Manual Cleanup in `delete_campaign()`

**Tables cleaned up manually:**
- `marts.fact_jobs` (fallback if FK constraint doesn't exist)
- `staging.jsearch_job_postings`
- `staging.chatgpt_enrichments` (via join to staging jobs)
- `raw.jsearch_job_postings`

**Implementation:** `services/campaign_management/campaign_service.py::delete_campaign()`

**Error Handling:**
- Uses `SAVEPOINT` and `ROLLBACK TO SAVEPOINT` for each cleanup step
- Ensures that if one cleanup step fails, others can still proceed
- Final campaign deletion triggers CASCADE DELETE for tables with FK constraints

### 4. Query Protection

**Job Queries:**
- `GET_JOBS_FOR_CAMPAIGN_BASE`: Uses `INNER JOIN marts.job_campaigns` to ensure campaign exists
- `GET_JOBS_FOR_USER_BASE`: Uses `INNER JOIN marts.job_campaigns` to ensure campaign exists
- `GET_JOB_BY_ID`: Uses `INNER JOIN marts.fact_jobs` to ensure complete job data

**Result:** Only jobs for existing campaigns with complete data are displayed

### 5. Campaign ID in User Tables

**Added `campaign_id` to:**
- `marts.user_job_status` (nullable, populated from job data)
- `marts.job_notes` (nullable, populated from job data)

**Benefits:**
- Allows CASCADE DELETE when campaigns are deleted
- Enables cleanup of orphaned user data
- Maintains data integrity

**Migration:** `docker/init/100_add_campaign_id_to_user_tables.sql`

**Service Updates:**
- `JobNoteService.add_note()`: Automatically looks up `campaign_id` from job if not provided
- `JobStatusService.upsert_status()`: Automatically looks up `campaign_id` from job if not provided

### 6. Cleanup Script

**Script:** `scripts/cleanup_orphaned_campaign_data.py`

**Purpose:**
- Removes orphaned data from deleted campaigns
- Can be run manually or scheduled
- Supports `--dry-run` mode for safety

**Usage:**
```bash
# Dry run (show what would be deleted)
python scripts/cleanup_orphaned_campaign_data.py --dry-run --verbose

# Actually delete orphaned data
python scripts/cleanup_orphaned_campaign_data.py --verbose
```

## Data Flow

### Campaign Creation
1. `campaign_id` is auto-generated by sequence
2. Campaign is inserted into `marts.job_campaigns`
3. ETL processes extract jobs and associate them with `campaign_id`

### Campaign Deletion
1. Manual cleanup of tables without FK constraints:
   - `marts.fact_jobs`
   - `staging.jsearch_job_postings`
   - `staging.chatgpt_enrichments`
   - `raw.jsearch_job_postings`
2. Delete campaign from `marts.job_campaigns`
3. CASCADE DELETE automatically removes:
   - `marts.dim_ranking`
   - `marts.etl_run_metrics`
   - `marts.fact_jobs` (if FK constraint exists)
   - `marts.user_job_status`
   - `marts.job_notes`

### Job Display
1. Queries join with `marts.job_campaigns` to ensure campaign exists
2. Queries use `INNER JOIN marts.fact_jobs` to ensure complete data
3. Only jobs with complete data for existing campaigns are displayed

## Testing

**Integration Tests:** `tests/integration/test_campaign_deletion.py`

**Test Coverage:**
- Campaign ID uniqueness
- Campaign ID auto-increment
- PRIMARY KEY constraint enforcement
- CASCADE DELETE for all related tables
- Manual cleanup for tables without FK constraints
- Query protection (only existing campaigns)
- No old jobs in new campaigns

**Run Tests:**
```bash
pytest tests/integration/test_campaign_deletion.py -v
```

## Migration Instructions

**For New Deployments:**
- Migrations run automatically during Docker initialization
- All migrations are idempotent and safe to run multiple times

**For Existing Deployments:**
```bash
# Run campaign uniqueness migration
psql -h localhost -U postgres -d job_search_db -f docker/init/99_fix_campaign_id_uniqueness.sql

# Run user tables migration
psql -h localhost -U postgres -d job_search_db -f docker/init/100_add_campaign_id_to_user_tables.sql
```

## Validation

**To verify the strategy is working:**
1. Create a campaign and run ETL
2. Delete the campaign
3. Verify all related data is removed:
   ```sql
   SELECT COUNT(*) FROM marts.dim_ranking WHERE campaign_id = <deleted_id>;
   SELECT COUNT(*) FROM marts.fact_jobs WHERE campaign_id = <deleted_id>;
   SELECT COUNT(*) FROM marts.user_job_status WHERE campaign_id = <deleted_id>;
   SELECT COUNT(*) FROM marts.job_notes WHERE campaign_id = <deleted_id>;
   ```
4. Create a new campaign
5. Verify it doesn't show old jobs
6. Verify campaign IDs are unique and incrementing

## Files Changed

- `docker/init/02_create_tables.sql` - Initial FK constraints
- `docker/init/99_fix_campaign_id_uniqueness.sql` - Campaign ID uniqueness
- `docker/init/100_add_campaign_id_to_user_tables.sql` - Add campaign_id to user tables
- `services/campaign_management/campaign_service.py` - Deletion logic
- `services/campaign_management/queries.py` - Updated queries
- `services/jobs/queries.py` - Query protection (INNER JOIN)
- `services/jobs/job_note_service.py` - Auto-lookup campaign_id
- `services/jobs/job_status_service.py` - Auto-lookup campaign_id
- `scripts/cleanup_orphaned_campaign_data.py` - Cleanup script
- `tests/integration/test_campaign_deletion.py` - Comprehensive tests
- `tests/integration/conftest.py` - Migration execution
