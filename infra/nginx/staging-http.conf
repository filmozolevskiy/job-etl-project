# Nginx configuration for staging environment (HTTP only)
#
# This configuration provides reverse proxy for staging services without SSL.
# Use this for initial setup and testing. Add SSL later with certbot.
#
# Installation:
#   1. Copy to /etc/nginx/sites-available/staging
#   2. ln -s /etc/nginx/sites-available/staging /etc/nginx/sites-enabled/
#   3. rm /etc/nginx/sites-enabled/default  # Remove default site
#   4. nginx -t && systemctl reload nginx
#
# Access URLs:
#   - Campaign UI: http://IP_ADDRESS/ (port 80)
#   - Frontend: http://IP_ADDRESS/app/
#   - Airflow: http://IP_ADDRESS/airflow/
#   - API: http://IP_ADDRESS/api/

# Staging slot 1 upstreams
upstream staging_1_campaign_ui {
    server 127.0.0.1:5001;
}

upstream staging_1_frontend {
    server 127.0.0.1:5174;
}

upstream staging_1_airflow {
    server 127.0.0.1:8081;
}

# Main HTTP server
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    # Logging
    access_log /var/log/nginx/staging-access.log;
    error_log /var/log/nginx/staging-error.log;

    # Campaign UI - main application (serves login, dashboard, etc.)
    location / {
        proxy_pass http://staging_1_campaign_ui;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
    }

    # React Frontend (standalone app)
    location /app/ {
        proxy_pass http://staging_1_frontend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_connect_timeout 10s;
    }

    # API routes
    location /api/ {
        proxy_pass http://staging_1_campaign_ui;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    # Airflow UI
    location /airflow/ {
        proxy_pass http://staging_1_airflow/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;

        # WebSocket support for Airflow logs
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Health check endpoint
    location /health {
        proxy_pass http://staging_1_campaign_ui/api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 10s;
        proxy_connect_timeout 5s;
    }

    # Version endpoint
    location /version {
        proxy_pass http://staging_1_campaign_ui/api/version;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 10s;
        proxy_connect_timeout 5s;
    }

    # Static file caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://staging_1_campaign_ui;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
